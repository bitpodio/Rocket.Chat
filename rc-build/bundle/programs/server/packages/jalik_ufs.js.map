{"version":3,"sources":["meteor://ðŸ’»app/packages/jalik:ufs/ufs.js","meteor://ðŸ’»app/packages/jalik:ufs/ufs-config.js","meteor://ðŸ’»app/packages/jalik:ufs/ufs-filter.js","meteor://ðŸ’»app/packages/jalik:ufs/ufs-methods.js","meteor://ðŸ’»app/packages/jalik:ufs/ufs-mime.js","meteor://ðŸ’»app/packages/jalik:ufs/ufs-server.js","meteor://ðŸ’»app/packages/jalik:ufs/ufs-store-permissions.js","meteor://ðŸ’»app/packages/jalik:ufs/ufs-store.js","meteor://ðŸ’»app/packages/jalik:ufs/ufs-tokens.js","meteor://ðŸ’»app/packages/jalik:ufs/ufs-uploader.js"],"names":["module1","export","UploadFS","Meteor","link","v","Random","Config","Filter","MIME","Store","StorePermissions","Tokens","Uploader","stores","store","tokens","addETagAttributeToFiles","where","getStores","forEach","files","getCollection","find","etag","fields","_id","file","direct","update","$set","generateEtag","addMimeType","extension","mime","toLowerCase","addPathAttributeToFiles","path","getFileRelativeURL","addStore","TypeError","getName","id","getMimeType","getMimeTypes","getStore","name","getTempFilePath","fileId","config","tmpDir","importFromURL","url","callback","call","readAsArrayBuffer","console","error","selectFile","input","document","createElement","type","multiple","onchange","ev","target","div","className","style","appendChild","body","click","selectFiles","i","length","isServer","require","global","isClient","window","module","_","constructor","options","extend","defaultStorePermissions","https","simulateReadDelay","simulateUploadSpeed","simulateWriteDelay","storesPath","tmpDirPermissions","parseInt","self","contentTypes","extensions","minSize","maxSize","invalidFileError","Error","fileTooSmallError","fileSize","minFileSize","fileTooLargeError","maxFileSize","invalidFileExtension","fileExtension","allowedExtensions","invalidFileType","fileType","allowedContentTypes","onCheck","Array","method","check","size","getMinSize","getMaxSize","getExtensions","includes","getContentTypes","fileTypes","isContentTypeInList","list","wildCardGlob","wildcards","filter","item","indexOf","replace","isValid","result","err","fs","Npm","http","Future","methods","ufsComplete","storeName","token","String","checkToken","fut","tmpFile","removeTempFile","unlink","message","findOne","validate","rs","createReadStream","flags","encoding","autoClose","on","bindEnvironment","remove","throw","write","return","wait","ufsCreate","Object","complete","uploading","substr","lastIndexOf","progress","userId","getFilter","create","createToken","uploadUrl","getURL","ufsDelete","count","ufsImportURL","split","pop","originalUrl","warn","proto","test","unblock","get","res","ufsStop","arc","ai","bin","bz","bz2","eps","exe","gz","gzip","js","json","ogx","pdf","ps","psd","rar","rev","swf","tar","xhtml","xml","zip","aif","aifc","aiff","au","flac","midi","mp2","mp3","mpa","oga","ogg","opus","ra","spx","wav","weba","wma","avs","bmp","gif","ico","jpeg","jpg","mjpg","pic","png","svg","tif","tiff","css","csv","html","txt","avi","dv","flv","mov","mp4","mpeg","mpg","ogv","vdo","webm","wmv","doc","docx","odb","odc","odf","odg","odi","odm","odp","ods","odt","otg","otp","ots","ott","ppt","pptx","xls","xlsx","WebApp","SparkMD5","default","domain","mkdirp","stream","URL","zlib","startup","mode","stat","log","chmod","d","connectHandlers","use","req","next","parsedUrl","parse","pathname","allowCORS","setHeader","regExp","RegExp","match","exec","writeHead","end","query","unique","hash","originalId","$ne","spark","ArrayBuffer","ws","createWriteStream","parseFloat","isNaN","Math","min","chunk","append","onRead","undefined","index","_sleepForMs","run","status","headers","ETag","modifiedAt","Date","toUTCString","uploadedAt","modifiedSince","range","total","unit","ranges","r","start","getReadStream","PassThrough","onReadError","emit","transformRead","accept","pipe","createGzip","createDeflate","insert","actions","action","modifiers","checkInsert","checkRemove","checkUpdate","_objectWithoutProperties","Mongo","collection","onCopyError","onFinishUpload","onValidate","onWriteError","permissions","transformWrite","Collection","value","copy","originalStore","copyId","generateToken","createdAt","errorHandler","finishHandler","readStream","data","getFileURL","copyTo","getWriteStream","after","before","delete","pattern","c","random","s","toString","round","toUpperCase","getRelativeURL","rootUrl","absoluteUrl","rootPath","trim","encodeURI","secure","request","response","setPermissions","writeStream","adaptive","capacity","chunkSize","maxChunkSize","maxTries","onAbort","onComplete","onCreate","onError","onProgress","onStart","onStop","retryDelay","transferDelay","RangeError","Blob","File","capacityMargin","offset","loaded","tries","postUrl","timeA","timeB","elapsedTime","startTime","finish","uploadedFile","abort","getAverageSpeed","seconds","getElapsedTime","getLoaded","isUploading","now","getFile","getProgress","getRemainingTime","averageSpeed","remainingBytes","max","getSpeed","getTotal","isComplete","readChunk","slice","setTimeout","sendChunk","duration","abs","xhr","XMLHttpRequest","onreadystatechange","readyState","open","send","stop"],"mappings":"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","file":"/packages/jalik_ufs.js","sourcesContent":["/*\n * The MIT License (MIT)\n *\n * Copyright (c) 2017 Karl STEIN\n *\n * Permission is hereby granted, free of charge, to any person obtaining a copy\n * of this software and associated documentation files (the \"Software\"), to deal\n * in the Software without restriction, including without limitation the rights\n * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n * copies of the Software, and to permit persons to whom the Software is\n * furnished to do so, subject to the following conditions:\n *\n * The above copyright notice and this permission notice shall be included in all\n * copies or substantial portions of the Software.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n * SOFTWARE.\n *\n */\nimport { Meteor } from 'meteor/meteor';\nimport { Random } from 'meteor/random';\n\nimport { Config } from './ufs-config';\nimport { Filter } from './ufs-filter';\nimport { MIME } from './ufs-mime';\nimport { Store } from './ufs-store';\nimport { StorePermissions } from './ufs-store-permissions';\nimport { Tokens } from './ufs-tokens';\nimport { Uploader } from './ufs-uploader';\n\nconst stores = {};\n\nexport const UploadFS = {\n\n\t/**\n   * Contains all stores\n   */\n\tstore: {},\n\n\t/**\n   * Collection of tokens\n   */\n\ttokens: Tokens,\n\n\t/**\n   * Adds the \"etag\" attribute to files\n   * @param where\n   */\n\taddETagAttributeToFiles(where) {\n\t\tthis.getStores().forEach((store) => {\n\t\t\tconst files = store.getCollection();\n\n\t\t\t// By default update only files with no path set\n\t\t\tfiles.find(where || { etag: null }, { fields: { _id: 1 } }).forEach((file) => {\n\t\t\t\tfiles.direct.update(file._id, { $set: { etag: this.generateEtag() } });\n\t\t\t});\n\t\t});\n\t},\n\n\t/**\n   * Adds the MIME type for an extension\n   * @param extension\n   * @param mime\n   */\n\taddMimeType(extension, mime) {\n\t\tMIME[extension.toLowerCase()] = mime;\n\t},\n\n\t/**\n   * Adds the \"path\" attribute to files\n   * @param where\n   */\n\taddPathAttributeToFiles(where) {\n\t\tthis.getStores().forEach((store) => {\n\t\t\tconst files = store.getCollection();\n\n\t\t\t// By default update only files with no path set\n\t\t\tfiles.find(where || { path: null }, { fields: { _id: 1 } }).forEach((file) => {\n\t\t\t\tfiles.direct.update(file._id, { $set: { path: store.getFileRelativeURL(file._id) } });\n\t\t\t});\n\t\t});\n\t},\n\n\t/**\n   * Registers the store\n   * @param store\n   */\n\taddStore(store) {\n\t\tif (!(store instanceof Store)) {\n\t\t\tthrow new TypeError('ufs: store is not an instance of UploadFS.Store.');\n\t\t}\n\t\tstores[store.getName()] = store;\n\t},\n\n\t/**\n   * Generates a unique ETag\n   * @return {string}\n   */\n\tgenerateEtag() {\n\t\treturn Random.id();\n\t},\n\n\t/**\n   * Returns the MIME type of the extension\n   * @param extension\n   * @returns {*}\n   */\n\tgetMimeType(extension) {\n\t\textension = extension.toLowerCase();\n\t\treturn MIME[extension];\n\t},\n\n\t/**\n   * Returns all MIME types\n   */\n\tgetMimeTypes() {\n\t\treturn MIME;\n\t},\n\n\t/**\n   * Returns the store by its name\n   * @param name\n   * @return {UploadFS.Store}\n   */\n\tgetStore(name) {\n\t\treturn stores[name];\n\t},\n\n\t/**\n   * Returns all stores\n   * @return {object}\n   */\n\tgetStores() {\n\t\treturn stores;\n\t},\n\n\t/**\n   * Returns the temporary file path\n   * @param fileId\n   * @return {string}\n   */\n\tgetTempFilePath(fileId) {\n\t\treturn `${ this.config.tmpDir }/${ fileId }`;\n\t},\n\n\t/**\n   * Imports a file from a URL\n   * @param url\n   * @param file\n   * @param store\n   * @param callback\n   */\n\timportFromURL(url, file, store, callback) {\n\t\tif (typeof store === 'string') {\n\t\t\tMeteor.call('ufsImportURL', url, file, store, callback);\n\t\t} else if (typeof store === 'object') {\n\t\t\tstore.importFromURL(url, file, callback);\n\t\t}\n\t},\n\n\t/**\n   * Returns file and data as ArrayBuffer for each files in the event\n   * @deprecated\n   * @param event\n   * @param callback\n   */\n\treadAsArrayBuffer() {\n\t\tconsole.error('UploadFS.readAsArrayBuffer is deprecated, see https://github.com/jalik/jalik-ufs#uploading-from-a-file');\n\t},\n\n\t/**\n   * Opens a dialog to select a single file\n   * @param callback\n   */\n\tselectFile(callback) {\n\t\tconst input = document.createElement('input');\n\t\tinput.type = 'file';\n\t\tinput.multiple = false;\n\t\tinput.onchange = (ev) => {\n\t\t\tconst { files } = ev.target;\n\t\t\tcallback.call(UploadFS, files[0]);\n\t\t};\n\t\t// Fix for iOS/Safari\n\t\tconst div = document.createElement('div');\n\t\tdiv.className = 'ufs-file-selector';\n\t\tdiv.style = 'display:none; height:0; width:0; overflow: hidden;';\n\t\tdiv.appendChild(input);\n\t\tdocument.body.appendChild(div);\n\t\t// Trigger file selection\n\t\tinput.click();\n\t},\n\n\t/**\n   * Opens a dialog to select multiple files\n   * @param callback\n   */\n\tselectFiles(callback) {\n\t\tconst input = document.createElement('input');\n\t\tinput.type = 'file';\n\t\tinput.multiple = true;\n\t\tinput.onchange = (ev) => {\n\t\t\tconst { files } = ev.target;\n\n\t\t\tfor (let i = 0; i < files.length; i += 1) {\n\t\t\t\tcallback.call(UploadFS, files[i]);\n\t\t\t}\n\t\t};\n\t\t// Fix for iOS/Safari\n\t\tconst div = document.createElement('div');\n\t\tdiv.className = 'ufs-file-selector';\n\t\tdiv.style = 'display:none; height:0; width:0; overflow: hidden;';\n\t\tdiv.appendChild(input);\n\t\tdocument.body.appendChild(div);\n\t\t// Trigger file selection\n\t\tinput.click();\n\t},\n};\n\nif (Meteor.isServer) {\n\trequire('./ufs-methods');\n\trequire('./ufs-server');\n}\n\n/**\n * UploadFS Configuration\n * @type {Config}\n */\nUploadFS.config = new Config();\n\n// Add classes to global namespace\nUploadFS.Config = Config;\nUploadFS.Filter = Filter;\nUploadFS.Store = Store;\nUploadFS.StorePermissions = StorePermissions;\nUploadFS.Uploader = Uploader;\n\nif (Meteor.isServer) {\n\t// Expose the module globally\n\tif (typeof global !== 'undefined') {\n\t\tglobal.UploadFS = UploadFS;\n\t}\n} else if (Meteor.isClient) {\n\t// Expose the module globally\n\tif (typeof window !== 'undefined') {\n\t\twindow.UploadFS = UploadFS;\n\t}\n}\n","/*\n * The MIT License (MIT)\n *\n * Copyright (c) 2017 Karl STEIN\n *\n * Permission is hereby granted, free of charge, to any person obtaining a copy\n * of this software and associated documentation files (the \"Software\"), to deal\n * in the Software without restriction, including without limitation the rights\n * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n * copies of the Software, and to permit persons to whom the Software is\n * furnished to do so, subject to the following conditions:\n *\n * The above copyright notice and this permission notice shall be included in all\n * copies or substantial portions of the Software.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n * SOFTWARE.\n *\n */\n\nimport { _ } from 'meteor/underscore';\n\nimport { StorePermissions } from './ufs-store-permissions';\n\n/**\n * UploadFS configuration\n */\nexport class Config {\n\tconstructor(options) {\n\t\t// Default options\n\t\toptions = _.extend({\n\t\t\tdefaultStorePermissions: null,\n\t\t\thttps: false,\n\t\t\tsimulateReadDelay: 0,\n\t\t\tsimulateUploadSpeed: 0,\n\t\t\tsimulateWriteDelay: 0,\n\t\t\tstoresPath: 'ufs',\n\t\t\ttmpDir: '/tmp/ufs',\n\t\t\ttmpDirPermissions: '0700',\n\t\t}, options);\n\n\t\t// Check options\n\t\tif (options.defaultStorePermissions && !(options.defaultStorePermissions instanceof StorePermissions)) {\n\t\t\tthrow new TypeError('Config: defaultStorePermissions is not an instance of StorePermissions');\n\t\t}\n\t\tif (typeof options.https !== 'boolean') {\n\t\t\tthrow new TypeError('Config: https is not a function');\n\t\t}\n\t\tif (typeof options.simulateReadDelay !== 'number') {\n\t\t\tthrow new TypeError('Config: simulateReadDelay is not a number');\n\t\t}\n\t\tif (typeof options.simulateUploadSpeed !== 'number') {\n\t\t\tthrow new TypeError('Config: simulateUploadSpeed is not a number');\n\t\t}\n\t\tif (typeof options.simulateWriteDelay !== 'number') {\n\t\t\tthrow new TypeError('Config: simulateWriteDelay is not a number');\n\t\t}\n\t\tif (typeof options.storesPath !== 'string') {\n\t\t\tthrow new TypeError('Config: storesPath is not a string');\n\t\t}\n\t\tif (typeof options.tmpDir !== 'string') {\n\t\t\tthrow new TypeError('Config: tmpDir is not a string');\n\t\t}\n\t\tif (typeof options.tmpDirPermissions !== 'string') {\n\t\t\tthrow new TypeError('Config: tmpDirPermissions is not a string');\n\t\t}\n\n\t\t/**\n     * Default store permissions\n     * @type {UploadFS.StorePermissions}\n     */\n\t\tthis.defaultStorePermissions = options.defaultStorePermissions;\n\t\t/**\n     * Use or not secured protocol in URLS\n     * @type {boolean}\n     */\n\t\tthis.https = options.https;\n\t\t/**\n     * The simulation read delay\n     * @type {Number}\n     */\n\t\tthis.simulateReadDelay = parseInt(options.simulateReadDelay);\n\t\t/**\n     * The simulation upload speed\n     * @type {Number}\n     */\n\t\tthis.simulateUploadSpeed = parseInt(options.simulateUploadSpeed);\n\t\t/**\n     * The simulation write delay\n     * @type {Number}\n     */\n\t\tthis.simulateWriteDelay = parseInt(options.simulateWriteDelay);\n\t\t/**\n     * The URL root path of stores\n     * @type {string}\n     */\n\t\tthis.storesPath = options.storesPath;\n\t\t/**\n     * The temporary directory of uploading files\n     * @type {string}\n     */\n\t\tthis.tmpDir = options.tmpDir;\n\t\t/**\n     * The permissions of the temporary directory\n     * @type {string}\n     */\n\t\tthis.tmpDirPermissions = options.tmpDirPermissions;\n\t}\n}\n","/*\n * The MIT License (MIT)\n *\n * Copyright (c) 2017 Karl STEIN\n *\n * Permission is hereby granted, free of charge, to any person obtaining a copy\n * of this software and associated documentation files (the \"Software\"), to deal\n * in the Software without restriction, including without limitation the rights\n * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n * copies of the Software, and to permit persons to whom the Software is\n * furnished to do so, subject to the following conditions:\n *\n * The above copyright notice and this permission notice shall be included in all\n * copies or substantial portions of the Software.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n * SOFTWARE.\n *\n */\nimport { Meteor } from 'meteor/meteor';\nimport { _ } from 'meteor/underscore';\n\n/**\n * File filter\n */\nexport class Filter {\n\tconstructor(options) {\n\t\tconst self = this;\n\n\t\t// Default options\n\t\toptions = _.extend({\n\t\t\tcontentTypes: null,\n\t\t\textensions: null,\n\t\t\tminSize: 1,\n\t\t\tmaxSize: 0,\n\t\t\tinvalidFileError: () => new Meteor.Error('invalid-file', 'File is not valid'),\n\t\t\tfileTooSmallError: (fileSize, minFileSize) => new Meteor.Error('file-too-small', `File size (size = ${ fileSize }) is too small (min = ${ minFileSize })`),\n\t\t\tfileTooLargeError: (fileSize, maxFileSize) => new Meteor.Error('file-too-large', `File size (size = ${ fileSize }) is too large (max = ${ maxFileSize })`),\n\t\t\tinvalidFileExtension: (fileExtension, allowedExtensions) => new Meteor.Error('invalid-file-extension', `File extension \"${ fileExtension }\" is not accepted (${ allowedExtensions })`),\n\t\t\tinvalidFileType: (fileType, allowedContentTypes) => new Meteor.Error('invalid-file-type', `File type \"${ fileType }\" is not accepted (${ allowedContentTypes })`),\n\t\t\tonCheck: this.onCheck,\n\t\t}, options);\n\n\t\t// Check options\n\t\tif (options.contentTypes && !(options.contentTypes instanceof Array)) {\n\t\t\tthrow new TypeError('Filter: contentTypes is not an Array');\n\t\t}\n\t\tif (options.extensions && !(options.extensions instanceof Array)) {\n\t\t\tthrow new TypeError('Filter: extensions is not an Array');\n\t\t}\n\t\tif (typeof options.minSize !== 'number') {\n\t\t\tthrow new TypeError('Filter: minSize is not a number');\n\t\t}\n\t\tif (typeof options.maxSize !== 'number') {\n\t\t\tthrow new TypeError('Filter: maxSize is not a number');\n\t\t}\n\t\tif (options.onCheck && typeof options.onCheck !== 'function') {\n\t\t\tthrow new TypeError('Filter: onCheck is not a function');\n\t\t}\n\n\t\t// Public attributes\n\t\tself.options = options;\n\t\t['onCheck'].forEach((method) => {\n\t\t\tif (typeof options[method] === 'function') {\n\t\t\t\tself[method] = options[method];\n\t\t\t}\n\t\t});\n\t}\n\n\t/**\n   * Checks the file\n   * @param file\n   */\n\tcheck(file) {\n\t\tlet error = null;\n\t\tif (typeof file !== 'object' || !file) {\n\t\t\terror = this.options.invalidFileError();\n\t\t}\n\t\t// Check size\n\t\tconst fileSize = file.size;\n\t\tconst minSize = this.getMinSize();\n\t\tif (fileSize <= 0 || fileSize < minSize) {\n\t\t\terror = this.options.fileTooSmallError(fileSize, minSize);\n\t\t}\n\t\tconst maxSize = this.getMaxSize();\n\t\tif (maxSize > 0 && fileSize > maxSize) {\n\t\t\terror = this.options.fileTooLargeError(fileSize, maxSize);\n\t\t}\n\t\t// Check extension\n\t\tconst allowedExtensions = this.getExtensions();\n\t\tconst fileExtension = file.extension;\n\t\tif (allowedExtensions && !allowedExtensions.includes(fileExtension)) {\n\t\t\terror = this.options.invalidFileExtension(fileExtension, allowedExtensions);\n\t\t}\n\t\t// Check content type\n\t\tconst allowedContentTypes = this.getContentTypes();\n\t\tconst fileTypes = file.type;\n\t\tif (allowedContentTypes && !this.isContentTypeInList(fileTypes, allowedContentTypes)) {\n\t\t\terror = this.options.invalidFileType(fileTypes, allowedContentTypes);\n\t\t}\n\t\t// Apply custom check\n\t\tif (typeof this.onCheck === 'function' && !this.onCheck(file)) {\n\t\t\terror = new Meteor.Error('invalid-file', 'File does not match filter');\n\t\t}\n\n\t\tif (error) {\n\t\t\tthrow error;\n\t\t}\n\t}\n\n\t/**\n   * Returns the allowed content types\n   * @return {Array}\n   */\n\tgetContentTypes() {\n\t\treturn this.options.contentTypes;\n\t}\n\n\t/**\n   * Returns the allowed extensions\n   * @return {Array}\n   */\n\tgetExtensions() {\n\t\treturn this.options.extensions;\n\t}\n\n\t/**\n   * Returns the maximum file size\n   * @return {Number}\n   */\n\tgetMaxSize() {\n\t\treturn this.options.maxSize;\n\t}\n\n\t/**\n   * Returns the minimum file size\n   * @return {Number}\n   */\n\tgetMinSize() {\n\t\treturn this.options.minSize;\n\t}\n\n\t/**\n   * Checks if content type is in the given list\n   * @param type\n   * @param list\n   * @return {boolean}\n   */\n\tisContentTypeInList(type, list) {\n\t\tif (typeof type === 'string' && list instanceof Array) {\n\t\t\tif (list.includes(type)) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\tconst wildCardGlob = '/*';\n\t\t\tconst wildcards = list.filter((item) => item.indexOf(wildCardGlob) > 0);\n\n\t\t\tif (wildcards.includes(type.replace(/(\\/.*)$/, wildCardGlob))) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\t\treturn false;\n\t}\n\n\t/**\n   * Checks if the file matches filter\n   * @param file\n   * @return {boolean}\n   */\n\tisValid(file) {\n\t\tlet result = true;\n\t\ttry {\n\t\t\tthis.check(file);\n\t\t} catch (err) {\n\t\t\tresult = false;\n\t\t}\n\t\treturn result;\n\t}\n\n\t/**\n   * Executes custom checks\n   * @param file\n   * @return {boolean}\n   */\n\t// eslint-disable-next-line no-unused-vars\n\tonCheck(file) {\n\t\treturn true;\n\t}\n}\n","/* eslint-disable no-undef */\n/*\n * The MIT License (MIT)\n *\n * Copyright (c) 2017 Karl STEIN\n *\n * Permission is hereby granted, free of charge, to any person obtaining a copy\n * of this software and associated documentation files (the \"Software\"), to deal\n * in the Software without restriction, including without limitation the rights\n * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n * copies of the Software, and to permit persons to whom the Software is\n * furnished to do so, subject to the following conditions:\n *\n * The above copyright notice and this permission notice shall be included in all\n * copies or substantial portions of the Software.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n * SOFTWARE.\n *\n */\n\nimport { check } from 'meteor/check';\nimport { Meteor } from 'meteor/meteor';\n\nimport { UploadFS } from './ufs';\nimport { Filter } from './ufs-filter';\nimport { Tokens } from './ufs-tokens';\n\nconst fs = Npm.require('fs');\nconst http = Npm.require('http');\nconst https = Npm.require('https');\nconst Future = Npm.require('fibers/future');\n\nif (Meteor.isServer) {\n\tMeteor.methods({\n\n\t\t/**\n     * Completes the file transfer\n     * @param fileId\n     * @param storeName\n     * @param token\n     */\n\t\tufsComplete(fileId, storeName, token) {\n\t\t\tcheck(fileId, String);\n\t\t\tcheck(storeName, String);\n\t\t\tcheck(token, String);\n\n\t\t\t// Get store\n\t\t\tconst store = UploadFS.getStore(storeName);\n\t\t\tif (!store) {\n\t\t\t\tthrow new Meteor.Error('invalid-store', 'Store not found');\n\t\t\t}\n\t\t\t// Check token\n\t\t\tif (!store.checkToken(token, fileId)) {\n\t\t\t\tthrow new Meteor.Error('invalid-token', 'Token is not valid');\n\t\t\t}\n\n\t\t\tconst fut = new Future();\n\t\t\tconst tmpFile = UploadFS.getTempFilePath(fileId);\n\n\t\t\tconst removeTempFile = function() {\n\t\t\t\tfs.unlink(tmpFile, function(err) {\n\t\t\t\t\terr && console.error(`ufs: cannot delete temp file \"${ tmpFile }\" (${ err.message })`);\n\t\t\t\t});\n\t\t\t};\n\n\t\t\ttry {\n\t\t\t\t// todo check if temp file exists\n\n\t\t\t\t// Get file\n\t\t\t\tconst file = store.getCollection().findOne({ _id: fileId });\n\n\t\t\t\t// Validate file before moving to the store\n\t\t\t\tstore.validate(file);\n\n\t\t\t\t// Get the temp file\n\t\t\t\tconst rs = fs.createReadStream(tmpFile, {\n\t\t\t\t\tflags: 'r',\n\t\t\t\t\tencoding: null,\n\t\t\t\t\tautoClose: true,\n\t\t\t\t});\n\n\t\t\t\t// Clean upload if error occurs\n\t\t\t\trs.on('error', Meteor.bindEnvironment(function(err) {\n\t\t\t\t\tconsole.error(err);\n\t\t\t\t\tstore.getCollection().remove({ _id: fileId });\n\t\t\t\t\tfut.throw(err);\n\t\t\t\t}));\n\n\t\t\t\t// Save file in the store\n\t\t\t\tstore.write(rs, fileId, Meteor.bindEnvironment(function(err, file) {\n\t\t\t\t\tremoveTempFile();\n\n\t\t\t\t\tif (err) {\n\t\t\t\t\t\tfut.throw(err);\n\t\t\t\t\t} else {\n\t\t\t\t\t\t// File has been fully uploaded\n\t\t\t\t\t\t// so we don't need to keep the token anymore.\n\t\t\t\t\t\t// Also this ensure that the file cannot be modified with extra chunks later.\n\t\t\t\t\t\tTokens.remove({ fileId });\n\t\t\t\t\t\tfut.return(file);\n\t\t\t\t\t}\n\t\t\t\t}));\n\n\t\t\t\t// catch will not work if fut.wait() is outside try/catch\n\t\t\t\treturn fut.wait();\n\t\t\t} catch (err) {\n\t\t\t\t// If write failed, remove the file\n\t\t\t\tstore.getCollection().remove({ _id: fileId });\n\t\t\t\t// removeTempFile(); // todo remove temp file on error or try again ?\n\t\t\t\tthrow new Meteor.Error('ufs: cannot upload file', err);\n\t\t\t}\n\t\t},\n\n\t\t/**\n     * Creates the file and returns the file upload token\n     * @param file\n     * @return {{fileId: string, token: *, url: *}}\n     */\n\t\tufsCreate(file) {\n\t\t\tcheck(file, Object);\n\n\t\t\tif (typeof file.name !== 'string' || !file.name.length) {\n\t\t\t\tthrow new Meteor.Error('invalid-file-name', 'file name is not valid');\n\t\t\t}\n\t\t\tif (typeof file.store !== 'string' || !file.store.length) {\n\t\t\t\tthrow new Meteor.Error('invalid-store', 'store is not valid');\n\t\t\t}\n\t\t\t// Get store\n\t\t\tconst store = UploadFS.getStore(file.store);\n\t\t\tif (!store) {\n\t\t\t\tthrow new Meteor.Error('invalid-store', 'Store not found');\n\t\t\t}\n\n\t\t\t// Set default info\n\t\t\tfile.complete = false;\n\t\t\tfile.uploading = false;\n\t\t\tfile.extension = file.name && file.name.substr((~-file.name.lastIndexOf('.') >>> 0) + 2).toLowerCase();\n\t\t\t// Assign file MIME type based on the extension\n\t\t\tif (file.extension && !file.type) {\n\t\t\t\tfile.type = UploadFS.getMimeType(file.extension) || 'application/octet-stream';\n\t\t\t}\n\t\t\tfile.progress = 0;\n\t\t\tfile.size = parseInt(file.size) || 0;\n\t\t\tfile.userId = file.userId || this.userId;\n\n\t\t\t// Check if the file matches store filter\n\t\t\tconst filter = store.getFilter();\n\t\t\tif (filter instanceof Filter) {\n\t\t\t\tfilter.check(file);\n\t\t\t}\n\n\t\t\t// Create the file\n\t\t\tconst fileId = store.create(file);\n\t\t\tconst token = store.createToken(fileId);\n\t\t\tconst uploadUrl = store.getURL(`${ fileId }?token=${ token }`);\n\n\t\t\treturn {\n\t\t\t\tfileId,\n\t\t\t\ttoken,\n\t\t\t\turl: uploadUrl,\n\t\t\t};\n\t\t},\n\n\t\t/**\n     * Deletes a file\n     * @param fileId\n     * @param storeName\n     * @param token\n     * @returns {*}\n     */\n\t\tufsDelete(fileId, storeName, token) {\n\t\t\tcheck(fileId, String);\n\t\t\tcheck(storeName, String);\n\t\t\tcheck(token, String);\n\n\t\t\t// Check store\n\t\t\tconst store = UploadFS.getStore(storeName);\n\t\t\tif (!store) {\n\t\t\t\tthrow new Meteor.Error('invalid-store', 'Store not found');\n\t\t\t}\n\t\t\t// Ignore files that does not exist\n\t\t\tif (store.getCollection().find({ _id: fileId }).count() === 0) {\n\t\t\t\treturn 1;\n\t\t\t}\n\t\t\t// Check token\n\t\t\tif (!store.checkToken(token, fileId)) {\n\t\t\t\tthrow new Meteor.Error('invalid-token', 'Token is not valid');\n\t\t\t}\n\t\t\treturn store.getCollection().remove({ _id: fileId });\n\t\t},\n\n\t\t/**\n     * Imports a file from the URL\n     * @param url\n     * @param file\n     * @param storeName\n     * @return {*}\n     */\n\t\tufsImportURL(url, file, storeName) {\n\t\t\tcheck(url, String);\n\t\t\tcheck(file, Object);\n\t\t\tcheck(storeName, String);\n\n\t\t\t// Check URL\n\t\t\tif (typeof url !== 'string' || url.length <= 0) {\n\t\t\t\tthrow new Meteor.Error('invalid-url', 'The url is not valid');\n\t\t\t}\n\t\t\t// Check file\n\t\t\tif (typeof file !== 'object' || file === null) {\n\t\t\t\tthrow new Meteor.Error('invalid-file', 'The file is not valid');\n\t\t\t}\n\t\t\t// Check store\n\t\t\tconst store = UploadFS.getStore(storeName);\n\t\t\tif (!store) {\n\t\t\t\tthrow new Meteor.Error('invalid-store', 'The store does not exist');\n\t\t\t}\n\n\t\t\t// Extract file info\n\t\t\tif (!file.name) {\n\t\t\t\tfile.name = url.replace(/\\?.*$/, '').split('/').pop();\n\t\t\t}\n\t\t\tif (file.name && !file.extension) {\n\t\t\t\tfile.extension = file.name && file.name.substr((~-file.name.lastIndexOf('.') >>> 0) + 2).toLowerCase();\n\t\t\t}\n\t\t\tif (file.extension && !file.type) {\n\t\t\t\t// Assign file MIME type based on the extension\n\t\t\t\tfile.type = UploadFS.getMimeType(file.extension) || 'application/octet-stream';\n\t\t\t}\n\t\t\t// Check if file is valid\n\t\t\tif (store.getFilter() instanceof Filter) {\n\t\t\t\tstore.getFilter().check(file);\n\t\t\t}\n\n\t\t\tif (file.originalUrl) {\n\t\t\t\tconsole.warn('ufs: The \"originalUrl\" attribute is automatically set when importing a file from a URL');\n\t\t\t}\n\n\t\t\t// Add original URL\n\t\t\tfile.originalUrl = url;\n\n\t\t\t// Create the file\n\t\t\tfile.complete = false;\n\t\t\tfile.uploading = true;\n\t\t\tfile.progress = 0;\n\t\t\tfile._id = store.create(file);\n\n\t\t\tconst fut = new Future();\n\t\t\tlet proto;\n\n\t\t\t// Detect protocol to use\n\t\t\tif (/http:\\/\\//i.test(url)) {\n\t\t\t\tproto = http;\n\t\t\t} else if (/https:\\/\\//i.test(url)) {\n\t\t\t\tproto = https;\n\t\t\t}\n\n\t\t\tthis.unblock();\n\n\t\t\t// Download file\n\t\t\tproto.get(url, Meteor.bindEnvironment(function(res) {\n\t\t\t\t// Save the file in the store\n\t\t\t\tstore.write(res, file._id, function(err, file) {\n\t\t\t\t\tif (err) {\n\t\t\t\t\t\tfut.throw(err);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tfut.return(file);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t})).on('error', function(err) {\n\t\t\t\tfut.throw(err);\n\t\t\t});\n\t\t\treturn fut.wait();\n\t\t},\n\n\t\t/**\n     * Marks the file uploading as stopped\n     * @param fileId\n     * @param storeName\n     * @param token\n     * @returns {*}\n     */\n\t\tufsStop(fileId, storeName, token) {\n\t\t\tcheck(fileId, String);\n\t\t\tcheck(storeName, String);\n\t\t\tcheck(token, String);\n\n\t\t\t// Check store\n\t\t\tconst store = UploadFS.getStore(storeName);\n\t\t\tif (!store) {\n\t\t\t\tthrow new Meteor.Error('invalid-store', 'Store not found');\n\t\t\t}\n\t\t\t// Check file\n\t\t\tconst file = store.getCollection().find({ _id: fileId }, { fields: { userId: 1 } });\n\t\t\tif (!file) {\n\t\t\t\tthrow new Meteor.Error('invalid-file', 'File not found');\n\t\t\t}\n\t\t\t// Check token\n\t\t\tif (!store.checkToken(token, fileId)) {\n\t\t\t\tthrow new Meteor.Error('invalid-token', 'Token is not valid');\n\t\t\t}\n\n\t\t\treturn store.getCollection().update({ _id: fileId }, {\n\t\t\t\t$set: { uploading: false },\n\t\t\t});\n\t\t},\n\t});\n}\n","/*\n * The MIT License (MIT)\n *\n * Copyright (c) 2017 Karl STEIN\n *\n * Permission is hereby granted, free of charge, to any person obtaining a copy\n * of this software and associated documentation files (the \"Software\"), to deal\n * in the Software without restriction, including without limitation the rights\n * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n * copies of the Software, and to permit persons to whom the Software is\n * furnished to do so, subject to the following conditions:\n *\n * The above copyright notice and this permission notice shall be included in all\n * copies or substantial portions of the Software.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n * SOFTWARE.\n *\n */\n\n/**\n * MIME types and extensions\n */\nexport const MIME = {\n\n\t// application\n\t'7z': 'application/x-7z-compressed',\n\tarc: 'application/octet-stream',\n\tai: 'application/postscript',\n\tbin: 'application/octet-stream',\n\tbz: 'application/x-bzip',\n\tbz2: 'application/x-bzip2',\n\teps: 'application/postscript',\n\texe: 'application/octet-stream',\n\tgz: 'application/x-gzip',\n\tgzip: 'application/x-gzip',\n\tjs: 'application/javascript',\n\tjson: 'application/json',\n\togx: 'application/ogg',\n\tpdf: 'application/pdf',\n\tps: 'application/postscript',\n\tpsd: 'application/octet-stream',\n\trar: 'application/x-rar-compressed',\n\trev: 'application/x-rar-compressed',\n\tswf: 'application/x-shockwave-flash',\n\ttar: 'application/x-tar',\n\txhtml: 'application/xhtml+xml',\n\txml: 'application/xml',\n\tzip: 'application/zip',\n\n\t// audio\n\taif: 'audio/aiff',\n\taifc: 'audio/aiff',\n\taiff: 'audio/aiff',\n\tau: 'audio/basic',\n\tflac: 'audio/flac',\n\tmidi: 'audio/midi',\n\tmp2: 'audio/mpeg',\n\tmp3: 'audio/mpeg',\n\tmpa: 'audio/mpeg',\n\toga: 'audio/ogg',\n\togg: 'audio/ogg',\n\topus: 'audio/ogg',\n\tra: 'audio/vnd.rn-realaudio',\n\tspx: 'audio/ogg',\n\twav: 'audio/x-wav',\n\tweba: 'audio/webm',\n\twma: 'audio/x-ms-wma',\n\n\t// image\n\tavs: 'image/avs-video',\n\tbmp: 'image/x-windows-bmp',\n\tgif: 'image/gif',\n\tico: 'image/vnd.microsoft.icon',\n\tjpeg: 'image/jpeg',\n\tjpg: 'image/jpg',\n\tmjpg: 'image/x-motion-jpeg',\n\tpic: 'image/pic',\n\tpng: 'image/png',\n\tsvg: 'image/svg+xml',\n\ttif: 'image/tiff',\n\ttiff: 'image/tiff',\n\n\t// text\n\tcss: 'text/css',\n\tcsv: 'text/csv',\n\thtml: 'text/html',\n\ttxt: 'text/plain',\n\n\t// video\n\tavi: 'video/avi',\n\tdv: 'video/x-dv',\n\tflv: 'video/x-flv',\n\tmov: 'video/quicktime',\n\tmp4: 'video/mp4',\n\tmpeg: 'video/mpeg',\n\tmpg: 'video/mpg',\n\togv: 'video/ogg',\n\tvdo: 'video/vdo',\n\twebm: 'video/webm',\n\twmv: 'video/x-ms-wmv',\n\n\t// specific to vendors\n\tdoc: 'application/msword',\n\tdocx: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',\n\todb: 'application/vnd.oasis.opendocument.database',\n\todc: 'application/vnd.oasis.opendocument.chart',\n\todf: 'application/vnd.oasis.opendocument.formula',\n\todg: 'application/vnd.oasis.opendocument.graphics',\n\todi: 'application/vnd.oasis.opendocument.image',\n\todm: 'application/vnd.oasis.opendocument.text-master',\n\todp: 'application/vnd.oasis.opendocument.presentation',\n\tods: 'application/vnd.oasis.opendocument.spreadsheet',\n\todt: 'application/vnd.oasis.opendocument.text',\n\totg: 'application/vnd.oasis.opendocument.graphics-template',\n\totp: 'application/vnd.oasis.opendocument.presentation-template',\n\tots: 'application/vnd.oasis.opendocument.spreadsheet-template',\n\tott: 'application/vnd.oasis.opendocument.text-template',\n\tppt: 'application/vnd.ms-powerpoint',\n\tpptx: 'application/vnd.openxmlformats-officedocument.presentationml.presentation',\n\txls: 'application/vnd.ms-excel',\n\txlsx: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',\n};\n","/* eslint-disable no-undef */\n/*\n * The MIT License (MIT)\n *\n * Copyright (c) 2017 Karl STEIN\n *\n * Permission is hereby granted, free of charge, to any person obtaining a copy\n * of this software and associated documentation files (the \"Software\"), to deal\n * in the Software without restriction, including without limitation the rights\n * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n * copies of the Software, and to permit persons to whom the Software is\n * furnished to do so, subject to the following conditions:\n *\n * The above copyright notice and this permission notice shall be included in all\n * copies or substantial portions of the Software.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n * SOFTWARE.\n *\n */\nimport { Meteor } from 'meteor/meteor';\nimport { WebApp } from 'meteor/webapp';\n// eslint-disable-next-line import/no-unresolved\nimport SparkMD5 from 'spark-md5';\n\nimport { UploadFS } from './ufs';\n\nif (Meteor.isServer) {\n\tconst domain = Npm.require('domain');\n\tconst fs = Npm.require('fs');\n\t// eslint-disable-next-line no-unused-vars\n\tconst http = Npm.require('http');\n\t// eslint-disable-next-line no-unused-vars\n\tconst https = Npm.require('https');\n\tconst mkdirp = Npm.require('mkdirp');\n\tconst stream = Npm.require('stream');\n\tconst URL = Npm.require('url');\n\tconst zlib = Npm.require('zlib');\n\n\tMeteor.startup(() => {\n\t\tconst path = UploadFS.config.tmpDir;\n\t\tconst mode = UploadFS.config.tmpDirPermissions;\n\n\t\tfs.stat(path, (err) => {\n\t\t\tif (err) {\n\t\t\t\t// Create the temp directory\n\t\t\t\tmkdirp(path, { mode }, (err) => {\n\t\t\t\t\tif (err) {\n\t\t\t\t\t\tconsole.error(`ufs: cannot create temp directory at \"${ path }\" (${ err.message })`);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconsole.log(`ufs: temp directory created at \"${ path }\"`);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\t// Set directory permissions\n\t\t\t\tfs.chmod(path, mode, (err) => {\n\t\t\t\t\terr && console.error(`ufs: cannot set temp directory permissions ${ mode } (${ err.message })`);\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t});\n\n\t// Create domain to handle errors\n\t// and possibly avoid server crashes.\n\tconst d = domain.create();\n\n\td.on('error', (err) => {\n\t\tconsole.error(`ufs: ${ err.message }`);\n\t});\n\n\t// Listen HTTP requests to serve files\n\tWebApp.connectHandlers.use((req, res, next) => {\n\t\t// Quick check to see if request should be caught\n\t\tif (!req.url.includes(`/${ UploadFS.config.storesPath }/`)) {\n\t\t\tnext();\n\t\t\treturn;\n\t\t}\n\n\t\t// Remove store path\n\t\tconst parsedUrl = URL.parse(req.url);\n\t\tconst path = parsedUrl.pathname.substr(UploadFS.config.storesPath.length + 1);\n\n\t\tconst allowCORS = () => {\n\t\t\t// res.setHeader('Access-Control-Allow-Origin', req.headers.origin);\n\t\t\tres.setHeader('Access-Control-Allow-Methods', 'POST');\n\t\t\tres.setHeader('Access-Control-Allow-Origin', '*');\n\t\t\tres.setHeader('Access-Control-Allow-Headers', 'Content-Type');\n\t\t};\n\n\t\tif (req.method === 'OPTIONS') {\n\t\t\tconst regExp = new RegExp('^\\/([^\\/\\?]+)\\/([^\\/\\?]+)$');\n\t\t\tconst match = regExp.exec(path);\n\n\t\t\t// Request is not valid\n\t\t\tif (match === null) {\n\t\t\t\tres.writeHead(400);\n\t\t\t\tres.end();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Get store\n\t\t\tconst store = UploadFS.getStore(match[1]);\n\t\t\tif (!store) {\n\t\t\t\tres.writeHead(404);\n\t\t\t\tres.end();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// If a store is found, go ahead and allow the origin\n\t\t\tallowCORS();\n\n\t\t\tnext();\n\t\t} else if (req.method === 'POST') {\n\t\t\t// Get store\n\t\t\tconst regExp = new RegExp('^\\/([^\\/\\?]+)\\/([^\\/\\?]+)$');\n\t\t\tconst match = regExp.exec(path);\n\n\t\t\t// Request is not valid\n\t\t\tif (match === null) {\n\t\t\t\tres.writeHead(400);\n\t\t\t\tres.end();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Get store\n\t\t\tconst store = UploadFS.getStore(match[1]);\n\t\t\tif (!store) {\n\t\t\t\tres.writeHead(404);\n\t\t\t\tres.end();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// If a store is found, go ahead and allow the origin\n\t\t\tallowCORS();\n\n\t\t\t// Get file\n\t\t\tconst fileId = match[2];\n\t\t\tif (store.getCollection().find({ _id: fileId }).count() === 0) {\n\t\t\t\tres.writeHead(404);\n\t\t\t\tres.end();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Check upload token\n\t\t\tif (!store.checkToken(req.query.token, fileId)) {\n\t\t\t\tres.writeHead(403);\n\t\t\t\tres.end();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Check if duplicate\n\t\t\tconst unique = function(hash) {\n\t\t\t\tconst originalId = store.getCollection().findOne({ hash, _id: { $ne: fileId } });\n\t\t\t\treturn originalId ? originalId._id : false;\n\t\t\t};\n\n\t\t\tconst spark = new SparkMD5.ArrayBuffer();\n\t\t\tconst tmpFile = UploadFS.getTempFilePath(fileId);\n\t\t\tconst ws = fs.createWriteStream(tmpFile, { flags: 'a' });\n\t\t\tconst fields = { uploading: true };\n\t\t\tconst progress = parseFloat(req.query.progress);\n\t\t\tif (!isNaN(progress) && progress > 0) {\n\t\t\t\tfields.progress = Math.min(progress, 1);\n\t\t\t}\n\n\t\t\treq.on('data', (chunk) => {\n\t\t\t\tws.write(chunk);\n\t\t\t\tspark.append(chunk);\n\t\t\t});\n\t\t\t// eslint-disable-next-line no-unused-vars\n\t\t\treq.on('error', (err) => {\n\t\t\t\tres.writeHead(500);\n\t\t\t\tres.end();\n\t\t\t});\n\t\t\treq.on('end', Meteor.bindEnvironment(() => {\n\t\t\t\t// Update completed state without triggering hooks\n\t\t\t\tfields.hash = spark.end();\n\t\t\t\tfields.originalId = unique(fields.hash);\n\t\t\t\tstore.getCollection().direct.update({ _id: fileId }, { $set: fields });\n\t\t\t\tws.end();\n\t\t\t}));\n\t\t\tws.on('error', (err) => {\n\t\t\t\tconsole.error(`ufs: cannot write chunk of file \"${ fileId }\" (${ err.message })`);\n\t\t\t\tfs.unlink(tmpFile, (err) => {\n\t\t\t\t\terr && console.error(`ufs: cannot delete temp file \"${ tmpFile }\" (${ err.message })`);\n\t\t\t\t});\n\t\t\t\tres.writeHead(500);\n\t\t\t\tres.end();\n\t\t\t});\n\t\t\tws.on('finish', () => {\n\t\t\t\tres.writeHead(204, { 'Content-Type': 'text/plain' });\n\t\t\t\tres.end();\n\t\t\t});\n\t\t} else if (req.method === 'GET') {\n\t\t\t// Get store, file Id and file name\n\t\t\tconst regExp = new RegExp('^\\/([^\\/\\?]+)\\/([^\\/\\?]+)(?:\\/([^\\/\\?]+))?$');\n\t\t\tconst match = regExp.exec(path);\n\n\t\t\t// Avoid 504 Gateway timeout error\n\t\t\t// if file is not handled by UploadFS.\n\t\t\tif (match === null) {\n\t\t\t\tnext();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Get store\n\t\t\tconst storeName = match[1];\n\t\t\tconst store = UploadFS.getStore(storeName);\n\n\t\t\tif (!store) {\n\t\t\t\tres.writeHead(404);\n\t\t\t\tres.end();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (store.onRead !== null && store.onRead !== undefined && typeof store.onRead !== 'function') {\n\t\t\t\tconsole.error(`ufs: Store.onRead is not a function in store \"${ storeName }\"`);\n\t\t\t\tres.writeHead(500);\n\t\t\t\tres.end();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Remove file extension from file Id\n\t\t\tconst index = match[2].indexOf('.');\n\t\t\tconst fileId = index !== -1 ? match[2].substr(0, index) : match[2];\n\n\t\t\t// Get file from database\n\t\t\tconst file = store.getCollection().findOne({ _id: fileId });\n\t\t\tif (!file) {\n\t\t\t\tres.writeHead(404);\n\t\t\t\tres.end();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Simulate read speed\n\t\t\tif (UploadFS.config.simulateReadDelay) {\n\t\t\t\tMeteor._sleepForMs(UploadFS.config.simulateReadDelay);\n\t\t\t}\n\n\t\t\td.run(() => {\n\t\t\t\t// Check if the file can be accessed\n\t\t\t\tif (store.onRead.call(store, fileId, file, req, res) !== false) {\n\t\t\t\t\tconst options = {};\n\t\t\t\t\tlet status = 200;\n\n\t\t\t\t\t// Prepare response headers\n\t\t\t\t\tconst headers = {\n\t\t\t\t\t\t'Content-Type': file.type,\n\t\t\t\t\t\t'Content-Length': file.size,\n\t\t\t\t\t};\n\n\t\t\t\t\t// Add ETag header\n\t\t\t\t\tif (typeof file.etag === 'string') {\n\t\t\t\t\t\theaders.ETag = file.etag;\n\t\t\t\t\t}\n\n\t\t\t\t\t// Add Last-Modified header\n\t\t\t\t\tif (file.modifiedAt instanceof Date) {\n\t\t\t\t\t\theaders['Last-Modified'] = file.modifiedAt.toUTCString();\n\t\t\t\t\t} else if (file.uploadedAt instanceof Date) {\n\t\t\t\t\t\theaders['Last-Modified'] = file.uploadedAt.toUTCString();\n\t\t\t\t\t}\n\n\t\t\t\t\t// Parse request headers\n\t\t\t\t\tif (typeof req.headers === 'object') {\n\t\t\t\t\t\t// Compare ETag\n\t\t\t\t\t\tif (req.headers['if-none-match']) {\n\t\t\t\t\t\t\tif (file.etag === req.headers['if-none-match']) {\n\t\t\t\t\t\t\t\tres.writeHead(304); // Not Modified\n\t\t\t\t\t\t\t\tres.end();\n\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// Compare file modification date\n\t\t\t\t\t\tif (req.headers['if-modified-since']) {\n\t\t\t\t\t\t\tconst modifiedSince = new Date(req.headers['if-modified-since']);\n\n\t\t\t\t\t\t\tif ((file.modifiedAt instanceof Date && file.modifiedAt > modifiedSince)\n                // eslint-disable-next-line no-mixed-operators\n                || file.uploadedAt instanceof Date && file.uploadedAt > modifiedSince) {\n\t\t\t\t\t\t\t\tres.writeHead(304); // Not Modified\n\t\t\t\t\t\t\t\tres.end();\n\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// Support range request\n\t\t\t\t\t\tif (typeof req.headers.range === 'string') {\n\t\t\t\t\t\t\tconst { range } = req.headers;\n\n\t\t\t\t\t\t\t// Range is not valid\n\t\t\t\t\t\t\tif (!range) {\n\t\t\t\t\t\t\t\tres.writeHead(416);\n\t\t\t\t\t\t\t\tres.end();\n\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tconst total = file.size;\n\t\t\t\t\t\t\tconst unit = range.substr(0, range.indexOf('='));\n\n\t\t\t\t\t\t\tif (unit !== 'bytes') {\n\t\t\t\t\t\t\t\tres.writeHead(416);\n\t\t\t\t\t\t\t\tres.end();\n\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tconst ranges = range.substr(unit.length).replace(/[^0-9\\-,]/, '').split(',');\n\n\t\t\t\t\t\t\tif (ranges.length > 1) {\n\t\t\t\t\t\t\t\t// todo: support multipart ranges: https://developer.mozilla.org/en-US/docs/Web/HTTP/Range_requests\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tconst r = ranges[0].split('-');\n\t\t\t\t\t\t\t\tconst start = parseInt(r[0], 10);\n\t\t\t\t\t\t\t\tconst end = r[1] ? parseInt(r[1], 10) : total - 1;\n\n\t\t\t\t\t\t\t\t// Range is not valid\n\t\t\t\t\t\t\t\tif (start < 0 || end >= total || start > end) {\n\t\t\t\t\t\t\t\t\tres.writeHead(416);\n\t\t\t\t\t\t\t\t\tres.end();\n\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t// Update headers\n\t\t\t\t\t\t\t\theaders['Content-Range'] = `bytes ${ start }-${ end }/${ total }`;\n\t\t\t\t\t\t\t\theaders['Content-Length'] = end - start + 1;\n\t\t\t\t\t\t\t\toptions.start = start;\n\t\t\t\t\t\t\t\toptions.end = end;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tstatus = 206; // partial content\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\theaders['Accept-Ranges'] = 'bytes';\n\t\t\t\t\t}\n\n\t\t\t\t\t// Open the file stream\n\t\t\t\t\tconst rs = store.getReadStream(fileId, file, options);\n\t\t\t\t\tconst ws = new stream.PassThrough();\n\n\t\t\t\t\trs.on('error', Meteor.bindEnvironment((err) => {\n\t\t\t\t\t\tstore.onReadError.call(store, err, fileId, file);\n\t\t\t\t\t\tres.end();\n\t\t\t\t\t}));\n\t\t\t\t\tws.on('error', Meteor.bindEnvironment((err) => {\n\t\t\t\t\t\tstore.onReadError.call(store, err, fileId, file);\n\t\t\t\t\t\tres.end();\n\t\t\t\t\t}));\n\t\t\t\t\tws.on('close', () => {\n\t\t\t\t\t\t// Close output stream at the end\n\t\t\t\t\t\tws.emit('end');\n\t\t\t\t\t});\n\n\t\t\t\t\t// Transform stream\n\t\t\t\t\tstore.transformRead(rs, ws, fileId, file, req, headers);\n\n\t\t\t\t\t// Parse request headers\n\t\t\t\t\tif (typeof req.headers === 'object') {\n\t\t\t\t\t\t// Compress data using if needed (ignore audio/video as they are already compressed)\n\t\t\t\t\t\tif (typeof req.headers['accept-encoding'] === 'string' && !/^(audio|video)/.test(file.type)) {\n\t\t\t\t\t\t\tconst accept = req.headers['accept-encoding'];\n\n\t\t\t\t\t\t\t// Compress with gzip\n\t\t\t\t\t\t\tif (accept.match(/\\bgzip\\b/)) {\n\t\t\t\t\t\t\t\theaders['Content-Encoding'] = 'gzip';\n\t\t\t\t\t\t\t\tdelete headers['Content-Length'];\n\t\t\t\t\t\t\t\tres.writeHead(status, headers);\n\t\t\t\t\t\t\t\tws.pipe(zlib.createGzip()).pipe(res);\n\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t// Compress with deflate\n\t\t\t\t\t\t\tif (accept.match(/\\bdeflate\\b/)) {\n\t\t\t\t\t\t\t\theaders['Content-Encoding'] = 'deflate';\n\t\t\t\t\t\t\t\tdelete headers['Content-Length'];\n\t\t\t\t\t\t\t\tres.writeHead(status, headers);\n\t\t\t\t\t\t\t\tws.pipe(zlib.createDeflate()).pipe(res);\n\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\t// Send raw data\n\t\t\t\t\tif (!headers['Content-Encoding']) {\n\t\t\t\t\t\tres.writeHead(status, headers);\n\t\t\t\t\t\tws.pipe(res);\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tres.end();\n\t\t\t\t}\n\t\t\t});\n\t\t} else {\n\t\t\tnext();\n\t\t}\n\t});\n}\n","/*\n * The MIT License (MIT)\n *\n * Copyright (c) 2017 Karl STEIN\n *\n * Permission is hereby granted, free of charge, to any person obtaining a copy\n * of this software and associated documentation files (the \"Software\"), to deal\n * in the Software without restriction, including without limitation the rights\n * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n * copies of the Software, and to permit persons to whom the Software is\n * furnished to do so, subject to the following conditions:\n *\n * The above copyright notice and this permission notice shall be included in all\n * copies or substantial portions of the Software.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n * SOFTWARE.\n *\n */\n\nimport { _ } from 'meteor/underscore';\n\n/**\n * Store permissions\n */\nexport class StorePermissions {\n\tconstructor(options) {\n\t\t// Default options\n\t\toptions = _.extend({\n\t\t\tinsert: null,\n\t\t\tremove: null,\n\t\t\tupdate: null,\n\t\t}, options);\n\n\t\t// Check options\n\t\tif (options.insert && typeof options.insert !== 'function') {\n\t\t\tthrow new TypeError('StorePermissions: insert is not a function');\n\t\t}\n\t\tif (options.remove && typeof options.remove !== 'function') {\n\t\t\tthrow new TypeError('StorePermissions: remove is not a function');\n\t\t}\n\t\tif (options.update && typeof options.update !== 'function') {\n\t\t\tthrow new TypeError('StorePermissions: update is not a function');\n\t\t}\n\n\t\t// Public attributes\n\t\tthis.actions = {\n\t\t\tinsert: options.insert,\n\t\t\tremove: options.remove,\n\t\t\tupdate: options.update,\n\t\t};\n\t}\n\n\t/**\n   * Checks the permission for the action\n   * @param action\n   * @param userId\n   * @param file\n   * @param fields\n   * @param modifiers\n   * @return {*}\n   */\n\tcheck(action, userId, file, fields, modifiers) {\n\t\tif (typeof this.actions[action] === 'function') {\n\t\t\treturn this.actions[action](userId, file, fields, modifiers);\n\t\t}\n\t\treturn true; // by default allow all\n\t}\n\n\t/**\n   * Checks the insert permission\n   * @param userId\n   * @param file\n   * @returns {*}\n   */\n\tcheckInsert(userId, file) {\n\t\treturn this.check('insert', userId, file);\n\t}\n\n\t/**\n   * Checks the remove permission\n   * @param userId\n   * @param file\n   * @returns {*}\n   */\n\tcheckRemove(userId, file) {\n\t\treturn this.check('remove', userId, file);\n\t}\n\n\t/**\n   * Checks the update permission\n   * @param userId\n   * @param file\n   * @param fields\n   * @param modifiers\n   * @returns {*}\n   */\n\tcheckUpdate(userId, file, fields, modifiers) {\n\t\treturn this.check('update', userId, file, fields, modifiers);\n\t}\n}\n","/*\n * The MIT License (MIT)\n *\n * Copyright (c) 2017 Karl STEIN\n *\n * Permission is hereby granted, free of charge, to any person obtaining a copy\n * of this software and associated documentation files (the \"Software\"), to deal\n * in the Software without restriction, including without limitation the rights\n * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n * copies of the Software, and to permit persons to whom the Software is\n * furnished to do so, subject to the following conditions:\n *\n * The above copyright notice and this permission notice shall be included in all\n * copies or substantial portions of the Software.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n * SOFTWARE.\n *\n */\nimport { check } from 'meteor/check';\nimport { Meteor } from 'meteor/meteor';\nimport { Mongo } from 'meteor/mongo';\nimport { _ } from 'meteor/underscore';\n\nimport { UploadFS } from './ufs';\nimport { Filter } from './ufs-filter';\nimport { StorePermissions } from './ufs-store-permissions';\nimport { Tokens } from './ufs-tokens';\n\n/**\n * File store\n */\nexport class Store {\n\tconstructor(options) {\n\t\tconst self = this;\n\n\t\t// Default options\n\t\toptions = _.extend({\n\t\t\tcollection: null,\n\t\t\tfilter: null,\n\t\t\tname: null,\n\t\t\tonCopyError: this.onCopyError,\n\t\t\tonFinishUpload: this.onFinishUpload,\n\t\t\tonRead: this.onRead,\n\t\t\tonReadError: this.onReadError,\n\t\t\tonValidate: this.onValidate,\n\t\t\tonWriteError: this.onWriteError,\n\t\t\tpermissions: null,\n\t\t\ttransformRead: null,\n\t\t\ttransformWrite: null,\n\t\t}, options);\n\n\t\t// Check options\n\t\tif (!(options.collection instanceof Mongo.Collection)) {\n\t\t\tthrow new TypeError('Store: collection is not a Mongo.Collection');\n\t\t}\n\t\tif (options.filter && !(options.filter instanceof Filter)) {\n\t\t\tthrow new TypeError('Store: filter is not a UploadFS.Filter');\n\t\t}\n\t\tif (typeof options.name !== 'string') {\n\t\t\tthrow new TypeError('Store: name is not a string');\n\t\t}\n\t\tif (UploadFS.getStore(options.name)) {\n\t\t\tthrow new TypeError('Store: name already exists');\n\t\t}\n\t\tif (options.onCopyError && typeof options.onCopyError !== 'function') {\n\t\t\tthrow new TypeError('Store: onCopyError is not a function');\n\t\t}\n\t\tif (options.onFinishUpload && typeof options.onFinishUpload !== 'function') {\n\t\t\tthrow new TypeError('Store: onFinishUpload is not a function');\n\t\t}\n\t\tif (options.onRead && typeof options.onRead !== 'function') {\n\t\t\tthrow new TypeError('Store: onRead is not a function');\n\t\t}\n\t\tif (options.onReadError && typeof options.onReadError !== 'function') {\n\t\t\tthrow new TypeError('Store: onReadError is not a function');\n\t\t}\n\t\tif (options.onWriteError && typeof options.onWriteError !== 'function') {\n\t\t\tthrow new TypeError('Store: onWriteError is not a function');\n\t\t}\n\t\tif (options.permissions && !(options.permissions instanceof StorePermissions)) {\n\t\t\tthrow new TypeError('Store: permissions is not a UploadFS.StorePermissions');\n\t\t}\n\t\tif (options.transformRead && typeof options.transformRead !== 'function') {\n\t\t\tthrow new TypeError('Store: transformRead is not a function');\n\t\t}\n\t\tif (options.transformWrite && typeof options.transformWrite !== 'function') {\n\t\t\tthrow new TypeError('Store: transformWrite is not a function');\n\t\t}\n\t\tif (options.onValidate && typeof options.onValidate !== 'function') {\n\t\t\tthrow new TypeError('Store: onValidate is not a function');\n\t\t}\n\n\t\t// Public attributes\n\t\tself.options = options;\n\t\tself.permissions = options.permissions;\n\t\t[\n\t\t\t'onCopyError',\n\t\t\t'onFinishUpload',\n\t\t\t'onRead',\n\t\t\t'onReadError',\n\t\t\t'onWriteError',\n\t\t\t'onValidate',\n\t\t].forEach((method) => {\n\t\t\tif (typeof options[method] === 'function') {\n\t\t\t\tself[method] = options[method];\n\t\t\t}\n\t\t});\n\n\t\t// Add the store to the list\n\t\tUploadFS.addStore(self);\n\n\t\t// Set default permissions\n\t\tif (!(self.permissions instanceof StorePermissions)) {\n\t\t\t// Uses custom default permissions or UFS default permissions\n\t\t\tif (UploadFS.config.defaultStorePermissions instanceof StorePermissions) {\n\t\t\t\tself.permissions = UploadFS.config.defaultStorePermissions;\n\t\t\t} else {\n\t\t\t\tself.permissions = new StorePermissions();\n\t\t\t\tconsole.warn(`ufs: permissions are not defined for store \"${ options.name }\"`);\n\t\t\t}\n\t\t}\n\n\t\tif (Meteor.isServer) {\n\t\t\t/**\n       * Checks token validity\n       * @param token\n       * @param fileId\n       * @returns {boolean}\n       */\n\t\t\tself.checkToken = function(token, fileId) {\n\t\t\t\tcheck(token, String);\n\t\t\t\tcheck(fileId, String);\n\t\t\t\treturn Tokens.find({ value: token, fileId }).count() === 1;\n\t\t\t};\n\n\t\t\t/**\n       * Copies the file to a store\n       * @param fileId\n       * @param store\n       * @param callback\n       */\n\t\t\tself.copy = function(fileId, store, callback) {\n\t\t\t\tcheck(fileId, String);\n\n\t\t\t\tif (!(store instanceof Store)) {\n\t\t\t\t\tthrow new TypeError('store is not an instance of UploadFS.Store');\n\t\t\t\t}\n\t\t\t\t// Get original file\n\t\t\t\tconst file = self.getCollection().findOne({ _id: fileId });\n\t\t\t\tif (!file) {\n\t\t\t\t\tthrow new Meteor.Error('file-not-found', 'File not found');\n\t\t\t\t}\n\t\t\t\t// Silently ignore the file if it does not match filter\n\t\t\t\tconst filter = store.getFilter();\n\t\t\t\tif (filter instanceof Filter && !filter.isValid(file)) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t// Prepare copy\n\t\t\t\tconst { _id, url, ...copy } = file;\n\t\t\t\tcopy.originalStore = self.getName();\n\t\t\t\tcopy.originalId = fileId;\n\n\t\t\t\t// Create the copy\n\t\t\t\tconst copyId = store.create(copy);\n\n\t\t\t\t// Get original stream\n\t\t\t\tconst rs = self.getReadStream(fileId, file);\n\n\t\t\t\t// Catch errors to avoid app crashing\n\t\t\t\trs.on('error', Meteor.bindEnvironment(function(err) {\n\t\t\t\t\tcallback.call(self, err, null);\n\t\t\t\t}));\n\n\t\t\t\t// Copy file data\n\t\t\t\tstore.write(rs, copyId, Meteor.bindEnvironment(function(err) {\n\t\t\t\t\tif (err) {\n\t\t\t\t\t\tself.getCollection().remove({ _id: copyId });\n\t\t\t\t\t\tself.onCopyError.call(self, err, fileId, file);\n\t\t\t\t\t}\n\t\t\t\t\tif (typeof callback === 'function') {\n\t\t\t\t\t\tcallback.call(self, err, copyId, copy, store);\n\t\t\t\t\t}\n\t\t\t\t}));\n\t\t\t};\n\n\t\t\t/**\n       * Creates the file in the collection\n       * @param file\n       * @param callback\n       * @return {string}\n       */\n\t\t\tself.create = function(file, callback) {\n\t\t\t\tcheck(file, Object);\n\t\t\t\tfile.store = self.options.name; // assign store to file\n\t\t\t\treturn self.getCollection().insert(file, callback);\n\t\t\t};\n\n\t\t\t/**\n       * Creates a token for the file (only needed for client side upload)\n       * @param fileId\n       * @returns {*}\n       */\n\t\t\tself.createToken = function(fileId) {\n\t\t\t\tconst token = self.generateToken();\n\n\t\t\t\t// Check if token exists\n\t\t\t\tif (Tokens.find({ fileId }).count()) {\n\t\t\t\t\tTokens.update({ fileId }, {\n\t\t\t\t\t\t$set: {\n\t\t\t\t\t\t\tcreatedAt: new Date(),\n\t\t\t\t\t\t\tvalue: token,\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\tTokens.insert({\n\t\t\t\t\t\tcreatedAt: new Date(),\n\t\t\t\t\t\tfileId,\n\t\t\t\t\t\tvalue: token,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\treturn token;\n\t\t\t};\n\n\t\t\t/**\n       * Writes the file to the store\n       * @param rs\n       * @param fileId\n       * @param callback\n       */\n\t\t\tself.write = function(rs, fileId, callback) {\n\t\t\t\tconst file = self.getCollection().findOne({ _id: fileId });\n\n\t\t\t\tconst errorHandler = Meteor.bindEnvironment(function(err) {\n\t\t\t\t\tself.onWriteError.call(self, err, fileId, file);\n\t\t\t\t\tcallback.call(self, err);\n\t\t\t\t});\n\n\t\t\t\tconst finishHandler = Meteor.bindEnvironment(function() {\n\t\t\t\t\tlet size = 0;\n\t\t\t\t\tconst readStream = self.getReadStream(fileId, file);\n\n\t\t\t\t\treadStream.on('error', Meteor.bindEnvironment(function(error) {\n\t\t\t\t\t\tcallback.call(self, error, null);\n\t\t\t\t\t}));\n\t\t\t\t\treadStream.on('data', Meteor.bindEnvironment(function(data) {\n\t\t\t\t\t\tsize += data.length;\n\t\t\t\t\t}));\n\t\t\t\t\treadStream.on('end', Meteor.bindEnvironment(function() {\n\t\t\t\t\t\t// Set file attribute\n\t\t\t\t\t\tfile.complete = true;\n\t\t\t\t\t\tfile.etag = UploadFS.generateEtag();\n\t\t\t\t\t\tfile.path = self.getFileRelativeURL(fileId);\n\t\t\t\t\t\tfile.progress = 1;\n\t\t\t\t\t\tfile.size = size;\n\t\t\t\t\t\tfile.token = self.generateToken();\n\t\t\t\t\t\tfile.uploading = false;\n\t\t\t\t\t\tfile.uploadedAt = new Date();\n\t\t\t\t\t\tfile.url = self.getFileURL(fileId);\n\n\t\t\t\t\t\t// Execute callback\n\t\t\t\t\t\tif (typeof self.onFinishUpload === 'function') {\n\t\t\t\t\t\t\tself.onFinishUpload.call(self, file);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// Sets the file URL when file transfer is complete,\n\t\t\t\t\t\t// this way, the image will loads entirely.\n\t\t\t\t\t\tself.getCollection().direct.update({ _id: fileId }, {\n\t\t\t\t\t\t\t$set: {\n\t\t\t\t\t\t\t\tcomplete: file.complete,\n\t\t\t\t\t\t\t\tetag: file.etag,\n\t\t\t\t\t\t\t\tpath: file.path,\n\t\t\t\t\t\t\t\tprogress: file.progress,\n\t\t\t\t\t\t\t\tsize: file.size,\n\t\t\t\t\t\t\t\ttoken: file.token,\n\t\t\t\t\t\t\t\tuploading: file.uploading,\n\t\t\t\t\t\t\t\tuploadedAt: file.uploadedAt,\n\t\t\t\t\t\t\t\turl: file.url,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\t// Return file info\n\t\t\t\t\t\tcallback.call(self, null, file);\n\n\t\t\t\t\t\t// Simulate write speed\n\t\t\t\t\t\tif (UploadFS.config.simulateWriteDelay) {\n\t\t\t\t\t\t\tMeteor._sleepForMs(UploadFS.config.simulateWriteDelay);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// Copy file to other stores\n\t\t\t\t\t\tif (self.options.copyTo instanceof Array) {\n\t\t\t\t\t\t\tfor (let i = 0; i < self.options.copyTo.length; i += 1) {\n\t\t\t\t\t\t\t\tconst store = self.options.copyTo[i];\n\n\t\t\t\t\t\t\t\tif (!store.getFilter() || store.getFilter().isValid(file)) {\n\t\t\t\t\t\t\t\t\tself.copy(fileId, store);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}));\n\t\t\t\t});\n\n\t\t\t\tconst ws = self.getWriteStream(fileId, file);\n\t\t\t\tws.on('error', errorHandler);\n\t\t\t\tws.on('finish', finishHandler);\n\n\t\t\t\t// Execute transformation\n\t\t\t\tself.transformWrite(rs, ws, fileId, file);\n\t\t\t};\n\t\t}\n\n\t\tif (Meteor.isServer) {\n\t\t\t// eslint-disable-next-line no-undef\n\t\t\tconst fs = Npm.require('fs');\n\t\t\tconst collection = self.getCollection();\n\n\t\t\t// Code executed after removing file\n\t\t\tcollection.after.remove(function(userId, file) {\n\t\t\t\t// Remove associated tokens\n\t\t\t\tTokens.remove({ fileId: file._id });\n\n\t\t\t\tif (self.options.copyTo instanceof Array) {\n\t\t\t\t\tfor (let i = 0; i < self.options.copyTo.length; i += 1) {\n\t\t\t\t\t\t// Remove copies in stores\n\t\t\t\t\t\tself.options.copyTo[i].getCollection().remove({ originalId: file._id });\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\n\t\t\t// Code executed before inserting file\n\t\t\tcollection.before.insert(function(userId, file) {\n\t\t\t\tif (!self.permissions.checkInsert(userId, file)) {\n\t\t\t\t\tthrow new Meteor.Error('forbidden', 'Forbidden');\n\t\t\t\t}\n\t\t\t});\n\n\t\t\t// Code executed before updating file\n\t\t\tcollection.before.update(function(userId, file, fields, modifiers) {\n\t\t\t\tif (!self.permissions.checkUpdate(userId, file, fields, modifiers)) {\n\t\t\t\t\tthrow new Meteor.Error('forbidden', 'Forbidden');\n\t\t\t\t}\n\t\t\t});\n\n\t\t\t// Code executed before removing file\n\t\t\tcollection.before.remove(function(userId, file) {\n\t\t\t\tif (!self.permissions.checkRemove(userId, file)) {\n\t\t\t\t\tthrow new Meteor.Error('forbidden', 'Forbidden');\n\t\t\t\t}\n\n\t\t\t\t// Delete the physical file in the store\n\t\t\t\tself.delete(file._id);\n\n\t\t\t\tconst tmpFile = UploadFS.getTempFilePath(file._id);\n\n\t\t\t\t// Delete the temp file\n\t\t\t\tfs.stat(tmpFile, function(err) {\n\t\t\t\t\t!err && fs.unlink(tmpFile, function(err) {\n\t\t\t\t\t\terr && console.error(`ufs: cannot delete temp file at ${ tmpFile } (${ err.message })`);\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\t}\n\n\t/**\n   * Deletes a file async\n   * @param fileId\n   * @param callback\n   */\n\t// eslint-disable-next-line no-unused-vars\n\tdelete(fileId, callback) {\n\t\tthrow new Error('delete is not implemented');\n\t}\n\n\t/**\n   * Generates a random token\n   * @param pattern\n   * @return {string}\n   */\n\tgenerateToken(pattern) {\n\t\treturn (pattern || 'xyxyxyxyxy').replace(/[xy]/g, (c) => {\n\t\t\t// eslint-disable-next-line no-mixed-operators\n\t\t\tconst r = Math.random() * 16 | 0; const v = c === 'x' ? r : r & 0x3 | 0x8;\n\t\t\tconst s = v.toString(16);\n\t\t\treturn Math.round(Math.random()) ? s.toUpperCase() : s;\n\t\t});\n\t}\n\n\t/**\n   * Returns the collection\n   * @return {Mongo.Collection}\n   */\n\tgetCollection() {\n\t\treturn this.options.collection;\n\t}\n\n\t/**\n   * Returns the file URL\n   * @param fileId\n   * @return {string|null}\n   */\n\tgetFileRelativeURL(fileId) {\n\t\tconst file = this.getCollection().findOne(fileId, { fields: { name: 1 } });\n\t\treturn file ? this.getRelativeURL(`${ fileId }/${ file.name }`) : null;\n\t}\n\n\t/**\n   * Returns the file URL\n   * @param fileId\n   * @return {string|null}\n   */\n\tgetFileURL(fileId) {\n\t\tconst file = this.getCollection().findOne(fileId, { fields: { name: 1 } });\n\t\treturn file ? this.getURL(`${ fileId }/${ file.name }`) : null;\n\t}\n\n\t/**\n   * Returns the file filter\n   * @return {UploadFS.Filter}\n   */\n\tgetFilter() {\n\t\treturn this.options.filter;\n\t}\n\n\t/**\n   * Returns the store name\n   * @return {string}\n   */\n\tgetName() {\n\t\treturn this.options.name;\n\t}\n\n\t/**\n   * Returns the file read stream\n   * @param fileId\n   * @param file\n   */\n\t// eslint-disable-next-line no-unused-vars\n\tgetReadStream(fileId, file) {\n\t\tthrow new Error('Store.getReadStream is not implemented');\n\t}\n\n\t/**\n   * Returns the store relative URL\n   * @param path\n   * @return {string}\n   */\n\tgetRelativeURL(path) {\n\t\tconst rootUrl = Meteor.absoluteUrl().replace(/\\/+$/, '');\n\t\tconst rootPath = rootUrl.replace(/^[a-z]+:\\/\\/[^/]+\\/*/gi, '');\n\t\tconst storeName = this.getName();\n\t\tpath = String(path).replace(/\\/$/, '').trim();\n\t\treturn encodeURI(`${ rootPath }/${ UploadFS.config.storesPath }/${ storeName }/${ path }`);\n\t}\n\n\t/**\n   * Returns the store absolute URL\n   * @param path\n   * @return {string}\n   */\n\tgetURL(path) {\n\t\tconst rootUrl = Meteor.absoluteUrl({ secure: UploadFS.config.https }).replace(/\\/+$/, '');\n\t\tconst storeName = this.getName();\n\t\tpath = String(path).replace(/\\/$/, '').trim();\n\t\treturn encodeURI(`${ rootUrl }/${ UploadFS.config.storesPath }/${ storeName }/${ path }`);\n\t}\n\n\t/**\n   * Returns the file write stream\n   * @param fileId\n   * @param file\n   */\n\t// eslint-disable-next-line no-unused-vars\n\tgetWriteStream(fileId, file) {\n\t\tthrow new Error('getWriteStream is not implemented');\n\t}\n\n\t/**\n   * Completes the file upload\n   * @param url\n   * @param file\n   * @param callback\n   */\n\timportFromURL(url, file, callback) {\n\t\tMeteor.call('ufsImportURL', url, file, this.getName(), callback);\n\t}\n\n\t/**\n   * Called when a copy error happened\n   * @param err\n   * @param fileId\n   * @param file\n   */\n\t// eslint-disable-next-line no-unused-vars\n\tonCopyError(err, fileId, file) {\n\t\tconsole.error(`ufs: cannot copy file \"${ fileId }\" (${ err.message })`, err);\n\t}\n\n\t/**\n   * Called when a file has been uploaded\n   * @param file\n   */\n\t// eslint-disable-next-line no-unused-vars\n\tonFinishUpload(file) {\n\t}\n\n\t/**\n   * Called when a file is read from the store\n   * @param fileId\n   * @param file\n   * @param request\n   * @param response\n   * @return boolean\n   */\n\t// eslint-disable-next-line no-unused-vars\n\tonRead(fileId, file, request, response) {\n\t\treturn true;\n\t}\n\n\t/**\n   * Called when a read error happened\n   * @param err\n   * @param fileId\n   * @param file\n   * @return boolean\n   */\n\t// eslint-disable-next-line no-unused-vars\n\tonReadError(err, fileId, file) {\n\t\tconsole.error(`ufs: cannot read file \"${ fileId }\" (${ err.message })`, err);\n\t}\n\n\t/**\n   * Called when file is being validated\n   * @param file\n   */\n\t// eslint-disable-next-line no-unused-vars\n\tonValidate(file) {\n\t}\n\n\t/**\n   * Called when a write error happened\n   * @param err\n   * @param fileId\n   * @param file\n   * @return boolean\n   */\n\t// eslint-disable-next-line no-unused-vars\n\tonWriteError(err, fileId, file) {\n\t\tconsole.error(`ufs: cannot write file \"${ fileId }\" (${ err.message })`, err);\n\t}\n\n\t/**\n   * Sets the store permissions\n   * @param permissions\n   */\n\tsetPermissions(permissions) {\n\t\tif (!(permissions instanceof StorePermissions)) {\n\t\t\tthrow new TypeError('Permissions is not an instance of UploadFS.StorePermissions');\n\t\t}\n\t\tthis.permissions = permissions;\n\t}\n\n\t/**\n   * Transforms the file on reading\n   * @param readStream\n   * @param writeStream\n   * @param fileId\n   * @param file\n   * @param request\n   * @param headers\n   */\n\ttransformRead(readStream, writeStream, fileId, file, request, headers) {\n\t\tif (typeof this.options.transformRead === 'function') {\n\t\t\tthis.options.transformRead.call(this, readStream, writeStream, fileId, file, request, headers);\n\t\t} else {\n\t\t\treadStream.pipe(writeStream);\n\t\t}\n\t}\n\n\t/**\n   * Transforms the file on writing\n   * @param readStream\n   * @param writeStream\n   * @param fileId\n   * @param file\n   */\n\ttransformWrite(readStream, writeStream, fileId, file) {\n\t\tif (typeof this.options.transformWrite === 'function') {\n\t\t\tthis.options.transformWrite.call(this, readStream, writeStream, fileId, file);\n\t\t} else {\n\t\t\treadStream.pipe(writeStream);\n\t\t}\n\t}\n\n\t/**\n   * Validates the file\n   * @param file\n   */\n\tvalidate(file) {\n\t\tif (typeof this.onValidate === 'function') {\n\t\t\tthis.onValidate(file);\n\t\t}\n\t}\n}\n","/*\n * The MIT License (MIT)\n *\n * Copyright (c) 2017 Karl STEIN\n *\n * Permission is hereby granted, free of charge, to any person obtaining a copy\n * of this software and associated documentation files (the \"Software\"), to deal\n * in the Software without restriction, including without limitation the rights\n * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n * copies of the Software, and to permit persons to whom the Software is\n * furnished to do so, subject to the following conditions:\n *\n * The above copyright notice and this permission notice shall be included in all\n * copies or substantial portions of the Software.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n * SOFTWARE.\n *\n */\n\nimport { Mongo } from 'meteor/mongo';\n\n/**\n * Collection of upload tokens\n * @type {Mongo.Collection}\n */\nexport const Tokens = new Mongo.Collection('ufsTokens');\n","/*\n * The MIT License (MIT)\n *\n * Copyright (c) 2017 Karl STEIN\n *\n * Permission is hereby granted, free of charge, to any person obtaining a copy\n * of this software and associated documentation files (the \"Software\"), to deal\n * in the Software without restriction, including without limitation the rights\n * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n * copies of the Software, and to permit persons to whom the Software is\n * furnished to do so, subject to the following conditions:\n *\n * The above copyright notice and this permission notice shall be included in all\n * copies or substantial portions of the Software.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n * SOFTWARE.\n *\n */\n\nimport { Meteor } from 'meteor/meteor';\nimport { _ } from 'meteor/underscore';\n\nimport { Store } from './ufs-store';\n\n/**\n * File uploader\n */\nexport class Uploader {\n\tconstructor(options) {\n\t\tconst self = this;\n\n\t\t// Set default options\n\t\toptions = _.extend({\n\t\t\tadaptive: true,\n\t\t\tcapacity: 0.9,\n\t\t\tchunkSize: 16 * 1024,\n\t\t\tdata: null,\n\t\t\tfile: null,\n\t\t\tmaxChunkSize: 4 * 1024 * 1000,\n\t\t\tmaxTries: 5,\n\t\t\tonAbort: this.onAbort,\n\t\t\tonComplete: this.onComplete,\n\t\t\tonCreate: this.onCreate,\n\t\t\tonError: this.onError,\n\t\t\tonProgress: this.onProgress,\n\t\t\tonStart: this.onStart,\n\t\t\tonStop: this.onStop,\n\t\t\tretryDelay: 2000,\n\t\t\tstore: null,\n\t\t\ttransferDelay: 100,\n\t\t}, options);\n\n\t\t// Check options\n\t\tif (typeof options.adaptive !== 'boolean') {\n\t\t\tthrow new TypeError('adaptive is not a number');\n\t\t}\n\t\tif (typeof options.capacity !== 'number') {\n\t\t\tthrow new TypeError('capacity is not a number');\n\t\t}\n\t\tif (options.capacity <= 0 || options.capacity > 1) {\n\t\t\tthrow new RangeError('capacity must be a float between 0.1 and 1.0');\n\t\t}\n\t\tif (typeof options.chunkSize !== 'number') {\n\t\t\tthrow new TypeError('chunkSize is not a number');\n\t\t}\n\t\tif (!(options.data instanceof Blob) && !(options.data instanceof File)) {\n\t\t\tthrow new TypeError('data is not an Blob or File');\n\t\t}\n\t\tif (options.file === null || typeof options.file !== 'object') {\n\t\t\tthrow new TypeError('file is not an object');\n\t\t}\n\t\tif (typeof options.maxChunkSize !== 'number') {\n\t\t\tthrow new TypeError('maxChunkSize is not a number');\n\t\t}\n\t\tif (typeof options.maxTries !== 'number') {\n\t\t\tthrow new TypeError('maxTries is not a number');\n\t\t}\n\t\tif (typeof options.retryDelay !== 'number') {\n\t\t\tthrow new TypeError('retryDelay is not a number');\n\t\t}\n\t\tif (typeof options.transferDelay !== 'number') {\n\t\t\tthrow new TypeError('transferDelay is not a number');\n\t\t}\n\t\tif (typeof options.onAbort !== 'function') {\n\t\t\tthrow new TypeError('onAbort is not a function');\n\t\t}\n\t\tif (typeof options.onComplete !== 'function') {\n\t\t\tthrow new TypeError('onComplete is not a function');\n\t\t}\n\t\tif (typeof options.onCreate !== 'function') {\n\t\t\tthrow new TypeError('onCreate is not a function');\n\t\t}\n\t\tif (typeof options.onError !== 'function') {\n\t\t\tthrow new TypeError('onError is not a function');\n\t\t}\n\t\tif (typeof options.onProgress !== 'function') {\n\t\t\tthrow new TypeError('onProgress is not a function');\n\t\t}\n\t\tif (typeof options.onStart !== 'function') {\n\t\t\tthrow new TypeError('onStart is not a function');\n\t\t}\n\t\tif (typeof options.onStop !== 'function') {\n\t\t\tthrow new TypeError('onStop is not a function');\n\t\t}\n\t\tif (typeof options.store !== 'string' && !(options.store instanceof Store)) {\n\t\t\tthrow new TypeError('store must be the name of the store or an instance of UploadFS.Store');\n\t\t}\n\n\t\t// Public attributes\n\t\tself.adaptive = options.adaptive;\n\t\tself.capacity = parseFloat(options.capacity);\n\t\tself.chunkSize = parseInt(options.chunkSize);\n\t\tself.maxChunkSize = parseInt(options.maxChunkSize);\n\t\tself.maxTries = parseInt(options.maxTries);\n\t\tself.retryDelay = parseInt(options.retryDelay);\n\t\tself.transferDelay = parseInt(options.transferDelay);\n\t\tself.onAbort = options.onAbort;\n\t\tself.onComplete = options.onComplete;\n\t\tself.onCreate = options.onCreate;\n\t\tself.onError = options.onError;\n\t\tself.onProgress = options.onProgress;\n\t\tself.onStart = options.onStart;\n\t\tself.onStop = options.onStop;\n\n\t\t// Private attributes\n\t\tlet { store } = options;\n\t\tconst { data } = options;\n\t\tconst capacityMargin = 0.1;\n\t\tlet { file } = options;\n\t\tlet fileId = null;\n\t\tlet offset = 0;\n\t\tlet loaded = 0;\n\t\tconst total = data.size;\n\t\tlet tries = 0;\n\t\tlet postUrl = null;\n\t\tlet token = null;\n\t\tlet complete = false;\n\t\tlet uploading = false;\n\n\t\tlet timeA = null;\n\t\tlet timeB = null;\n\n\t\tlet elapsedTime = 0;\n\t\tlet startTime = 0;\n\n\t\t// Keep only the name of the store\n\t\tif (store instanceof Store) {\n\t\t\tstore = store.getName();\n\t\t}\n\n\t\t// Assign file to store\n\t\tfile.store = store;\n\n\t\tfunction finish() {\n\t\t\t// Finish the upload by telling the store the upload is complete\n\t\t\tMeteor.call('ufsComplete', fileId, store, token, function(err, uploadedFile) {\n\t\t\t\tif (err) {\n\t\t\t\t\tself.onError(err, file);\n\t\t\t\t\tself.abort();\n\t\t\t\t} else if (uploadedFile) {\n\t\t\t\t\tuploading = false;\n\t\t\t\t\tcomplete = true;\n\t\t\t\t\tfile = uploadedFile;\n\t\t\t\t\tself.onComplete(uploadedFile);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\t/**\n     * Aborts the current transfer\n     */\n\t\tself.abort = function() {\n\t\t\t// Remove the file from database\n\t\t\t// eslint-disable-next-line no-unused-vars\n\t\t\tMeteor.call('ufsDelete', fileId, store, token, function(err, result) {\n\t\t\t\tif (err) {\n\t\t\t\t\tself.onError(err, file);\n\t\t\t\t}\n\t\t\t});\n\n\t\t\t// Reset uploader status\n\t\t\tuploading = false;\n\t\t\tfileId = null;\n\t\t\toffset = 0;\n\t\t\ttries = 0;\n\t\t\tloaded = 0;\n\t\t\tcomplete = false;\n\t\t\tstartTime = null;\n\t\t\tself.onAbort(file);\n\t\t};\n\n\t\t/**\n     * Returns the average speed in bytes per second\n     * @returns {number}\n     */\n\t\tself.getAverageSpeed = function() {\n\t\t\tconst seconds = self.getElapsedTime() / 1000;\n\t\t\treturn self.getLoaded() / seconds;\n\t\t};\n\n\t\t/**\n     * Returns the elapsed time in milliseconds\n     * @returns {number}\n     */\n\t\tself.getElapsedTime = function() {\n\t\t\tif (startTime && self.isUploading()) {\n\t\t\t\treturn elapsedTime + (Date.now() - startTime);\n\t\t\t}\n\t\t\treturn elapsedTime;\n\t\t};\n\n\t\t/**\n     * Returns the file\n     * @return {object}\n     */\n\t\tself.getFile = function() {\n\t\t\treturn file;\n\t\t};\n\n\t\t/**\n     * Returns the loaded bytes\n     * @return {number}\n     */\n\t\tself.getLoaded = function() {\n\t\t\treturn loaded;\n\t\t};\n\n\t\t/**\n     * Returns current progress\n     * @return {number}\n     */\n\t\tself.getProgress = function() {\n\t\t\treturn Math.min((loaded / total) * 100 / 100, 1.0);\n\t\t};\n\n\t\t/**\n     * Returns the remaining time in milliseconds\n     * @returns {number}\n     */\n\t\tself.getRemainingTime = function() {\n\t\t\tconst averageSpeed = self.getAverageSpeed();\n\t\t\tconst remainingBytes = total - self.getLoaded();\n\t\t\treturn averageSpeed && remainingBytes ? Math.max(remainingBytes / averageSpeed, 0) : 0;\n\t\t};\n\n\t\t/**\n     * Returns the upload speed in bytes per second\n     * @returns {number}\n     */\n\t\tself.getSpeed = function() {\n\t\t\tif (timeA && timeB && self.isUploading()) {\n\t\t\t\tconst seconds = (timeB - timeA) / 1000;\n\t\t\t\treturn self.chunkSize / seconds;\n\t\t\t}\n\t\t\treturn 0;\n\t\t};\n\n\t\t/**\n     * Returns the total bytes\n     * @return {number}\n     */\n\t\tself.getTotal = function() {\n\t\t\treturn total;\n\t\t};\n\n\t\t/**\n     * Checks if the transfer is complete\n     * @return {boolean}\n     */\n\t\tself.isComplete = function() {\n\t\t\treturn complete;\n\t\t};\n\n\t\t/**\n     * Checks if the transfer is active\n     * @return {boolean}\n     */\n\t\tself.isUploading = function() {\n\t\t\treturn uploading;\n\t\t};\n\n\t\t/**\n     * Reads a portion of file\n     * @param start\n     * @param length\n     * @param callback\n     * @returns {Blob}\n     */\n\t\tself.readChunk = function(start, length, callback) {\n\t\t\tif (typeof callback !== 'function') {\n\t\t\t\tthrow new Error('readChunk is missing callback');\n\t\t\t}\n\t\t\ttry {\n\t\t\t\tlet end;\n\n\t\t\t\t// Calculate the chunk size\n\t\t\t\tif (length && start + length > total) {\n\t\t\t\t\tend = total;\n\t\t\t\t} else {\n\t\t\t\t\tend = start + length;\n\t\t\t\t}\n\t\t\t\t// Get chunk\n\t\t\t\tconst chunk = data.slice(start, end);\n\t\t\t\t// Pass chunk to callback\n\t\t\t\tcallback.call(self, null, chunk);\n\t\t\t} catch (err) {\n\t\t\t\tconsole.error('read error', err);\n\t\t\t\t// Retry to read chunk\n\t\t\t\tMeteor.setTimeout(function() {\n\t\t\t\t\tif (tries < self.maxTries) {\n\t\t\t\t\t\ttries += 1;\n\t\t\t\t\t\tself.readChunk(start, length, callback);\n\t\t\t\t\t}\n\t\t\t\t}, self.retryDelay);\n\t\t\t}\n\t\t};\n\n\t\t/**\n     * Sends a file chunk to the store\n     */\n\t\tself.sendChunk = function() {\n\t\t\tif (!complete && startTime !== null) {\n\t\t\t\tif (offset < total) {\n\t\t\t\t\tlet { chunkSize } = self;\n\n\t\t\t\t\t// Use adaptive length\n\t\t\t\t\tif (self.adaptive && timeA && timeB && timeB > timeA) {\n\t\t\t\t\t\tconst duration = (timeB - timeA) / 1000;\n\t\t\t\t\t\tconst max = self.capacity * (1 + capacityMargin);\n\t\t\t\t\t\tconst min = self.capacity * (1 - capacityMargin);\n\n\t\t\t\t\t\tif (duration >= max) {\n\t\t\t\t\t\t\tchunkSize = Math.abs(Math.round(chunkSize * (max - duration)));\n\t\t\t\t\t\t} else if (duration < min) {\n\t\t\t\t\t\t\tchunkSize = Math.round(chunkSize * (min / duration));\n\t\t\t\t\t\t}\n\t\t\t\t\t\t// Limit to max chunk size\n\t\t\t\t\t\tif (self.maxChunkSize > 0 && chunkSize > self.maxChunkSize) {\n\t\t\t\t\t\t\tchunkSize = self.maxChunkSize;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\t// Reduce chunk size to fit total\n\t\t\t\t\tif (offset + chunkSize > total) {\n\t\t\t\t\t\tchunkSize = total - offset;\n\t\t\t\t\t}\n\n\t\t\t\t\t// Prepare the chunk\n\t\t\t\t\tself.readChunk(offset, chunkSize, function(err, chunk) {\n\t\t\t\t\t\tif (err) {\n\t\t\t\t\t\t\tself.onError(err, file);\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst xhr = new XMLHttpRequest();\n\t\t\t\t\t\txhr.onreadystatechange = function() {\n\t\t\t\t\t\t\tif (xhr.readyState === 4) {\n\t\t\t\t\t\t\t\tif ([200, 201, 202, 204].includes(xhr.status)) {\n\t\t\t\t\t\t\t\t\ttimeB = Date.now();\n\t\t\t\t\t\t\t\t\toffset += chunkSize;\n\t\t\t\t\t\t\t\t\tloaded += chunkSize;\n\n\t\t\t\t\t\t\t\t\t// Send next chunk\n\t\t\t\t\t\t\t\t\tself.onProgress(file, self.getProgress());\n\n\t\t\t\t\t\t\t\t\t// Finish upload\n\t\t\t\t\t\t\t\t\tif (loaded >= total) {\n\t\t\t\t\t\t\t\t\t\telapsedTime = Date.now() - startTime;\n\t\t\t\t\t\t\t\t\t\tfinish();\n\t\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t\tMeteor.setTimeout(self.sendChunk, self.transferDelay);\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t} else if (![402, 403, 404, 500].includes(xhr.status)) {\n\t\t\t\t\t\t\t\t\t// Retry until max tries is reach\n\t\t\t\t\t\t\t\t\t// But don't retry if these errors occur\n\t\t\t\t\t\t\t\t\tif (tries <= self.maxTries) {\n\t\t\t\t\t\t\t\t\t\ttries += 1;\n\t\t\t\t\t\t\t\t\t\t// Wait before retrying\n\t\t\t\t\t\t\t\t\t\tMeteor.setTimeout(self.sendChunk, self.retryDelay);\n\t\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t\tself.abort();\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\tself.abort();\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\t// Calculate upload progress\n\t\t\t\t\t\tconst progress = (offset + chunkSize) / total;\n\t\t\t\t\t\t// let formData = new FormData();\n\t\t\t\t\t\t// formData.append('progress', progress);\n\t\t\t\t\t\t// formData.append('chunk', chunk);\n\t\t\t\t\t\tconst url = `${ postUrl }&progress=${ progress }`;\n\n\t\t\t\t\t\ttimeA = Date.now();\n\t\t\t\t\t\ttimeB = null;\n\t\t\t\t\t\tuploading = true;\n\n\t\t\t\t\t\t// Send chunk to the store\n\t\t\t\t\t\txhr.open('POST', url, true);\n\t\t\t\t\t\txhr.send(chunk);\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\n\t\t/**\n     * Starts or resumes the transfer\n     */\n\t\tself.start = function() {\n\t\t\tif (!fileId) {\n\t\t\t\t// Create the file document and get the token\n\t\t\t\t// that allows the user to send chunks to the store.\n\t\t\t\tMeteor.call('ufsCreate', _.extend({}, file), function(err, result) {\n\t\t\t\t\tif (err) {\n\t\t\t\t\t\tself.onError(err, file);\n\t\t\t\t\t} else if (result) {\n\t\t\t\t\t\ttoken = result.token;\n\t\t\t\t\t\tpostUrl = result.url;\n\t\t\t\t\t\tfileId = result.fileId;\n\t\t\t\t\t\tfile._id = result.fileId;\n\t\t\t\t\t\tself.onCreate(file);\n\t\t\t\t\t\ttries = 0;\n\t\t\t\t\t\tstartTime = Date.now();\n\t\t\t\t\t\tself.onStart(file);\n\t\t\t\t\t\tself.sendChunk();\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t} else if (!uploading && !complete) {\n\t\t\t\t// Resume uploading\n\t\t\t\ttries = 0;\n\t\t\t\tstartTime = Date.now();\n\t\t\t\tself.onStart(file);\n\t\t\t\tself.sendChunk();\n\t\t\t}\n\t\t};\n\n\t\t/**\n     * Stops the transfer\n     */\n\t\tself.stop = function() {\n\t\t\tif (uploading) {\n\t\t\t\t// Update elapsed time\n\t\t\t\telapsedTime = Date.now() - startTime;\n\t\t\t\tstartTime = null;\n\t\t\t\tuploading = false;\n\t\t\t\tself.onStop(file);\n\n\t\t\t\t// eslint-disable-next-line no-unused-vars\n\t\t\t\tMeteor.call('ufsStop', fileId, store, token, function(err, result) {\n\t\t\t\t\tif (err) {\n\t\t\t\t\t\tself.onError(err, file);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t};\n\t}\n\n\t/**\n   * Called when the file upload is aborted\n   * @param file\n   */\n\t// eslint-disable-next-line no-unused-vars\n\tonAbort(file) {\n\t}\n\n\t/**\n   * Called when the file upload is complete\n   * @param file\n   */\n\t// eslint-disable-next-line no-unused-vars\n\tonComplete(file) {\n\t}\n\n\t/**\n   * Called when the file is created in the collection\n   * @param file\n   */\n\t// eslint-disable-next-line no-unused-vars\n\tonCreate(file) {\n\t}\n\n\t/**\n   * Called when an error occurs during file upload\n   * @param err\n   * @param file\n   */\n\t// eslint-disable-next-line no-unused-vars\n\tonError(err, file) {\n\t\tconsole.error(`ufs: ${ err.message }`);\n\t}\n\n\t/**\n   * Called when a file chunk has been sent\n   * @param file\n   * @param progress is a float from 0.0 to 1.0\n   */\n\t// eslint-disable-next-line no-unused-vars\n\tonProgress(file, progress) {\n\t}\n\n\t/**\n   * Called when the file upload starts\n   * @param file\n   */\n\t// eslint-disable-next-line no-unused-vars\n\tonStart(file) {\n\t}\n\n\t/**\n   * Called when the file upload stops\n   * @param file\n   */\n\t// eslint-disable-next-line no-unused-vars\n\tonStop(file) {\n\t}\n}\n"]}