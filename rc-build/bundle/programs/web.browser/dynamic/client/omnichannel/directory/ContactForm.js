function module(e,t,n){let a,l,o,r,s,i,c,u,m,d,h,E,p,k,f,v,C,_,D,b,x,F,g,w;n.export({ContactEditWithData:()=>T,ContactNewEdit:()=>G}),n.link("react",{default(e){a=e},useState(e){l=e},useMemo(e){o=e}},0),n.link("@rocket.chat/fuselage",{Field(e){r=e},TextInput(e){s=e},ButtonGroup(e){i=e},Button(e){c=e},Box(e){u=e}},1),n.link("@rocket.chat/fuselage-hooks",{useMutableCallback(e){m=e}},2),n.link("use-subscription",{useSubscription(e){d=e}},3),n.link("../../contexts/TranslationContext",{useTranslation(e){h=e}},4),n.link("../../components/VerticalBar",{default(e){E=e}},5),n.link("../../hooks/useForm",{useForm(e){p=e}},6),n.link("../../../app/utils",{isEmail(e){k=e}},7),n.link("../../hooks/useComponentDidUpdate",{useComponentDidUpdate(e){f=e}},8),n.link("../../hooks/useEndpointAction",{useEndpointAction(e){v=e}},9),n.link("../../contexts/ToastMessagesContext",{useToastMessageDispatch(e){C=e}},10),n.link("../../hooks/useEndpointData",{useEndpointData(e){_=e}},11),n.link("./Skeleton",{FormSkeleton(e){D=e}},12),n.link("../../components/CustomFieldsForm",{default(e){b=e}},13),n.link("../../../app/authorization",{hasAtLeastOnePermission(e){x=e}},14),n.link("../../hooks/useAsyncState",{AsyncStatePhase(e){F=e}},15),n.link("../../views/omnichannel/additionalForms",{formsSubscription(e){g=e}},16),n.link("../../components/helpers",{createToken(e){w=e}},17);const y={token:"",name:"",email:"",phone:"",username:""},S=e=>{var t;if(!e)return y;const{contact:{name:n,token:a,phone:l,visitorEmails:o,livechatData:r,contactManager:s}}=e;return{token:null!=a?a:"",name:null!=n?n:"",email:o?o[0].address:"",phone:l?l[0].phoneNumber:"",livechatData:null!=r?r:"",username:null!==(t=null==s?void 0:s.username)&&void 0!==t?t:""}};function T(e){let{id:t,reload:n,close:l}=e;const o=h(),{value:r,phase:s,error:i}=_("omnichannel/contact?contactId=".concat(t));return[s].includes(F.LOADING)?a.createElement(D,null):!i&&r&&r.contact?a.createElement(G,{id:t,data:r,reload:n,close:l}):a.createElement(u,{mbs:"x16"},o("Contact_not_found"))}function G(e){let{id:t,data:n,reload:u,close:y}=e;const T=h(),G=()=>x(["view-livechat-room-customfields","edit-livechat-room-customfields"]),{values:A,handlers:L}=p(S(n)),M=d(g),{useContactManager:N=(()=>{})}=M,B=N(),{handleName:P,handleEmail:V,handlePhone:q,handleUsername:I}=L,{token:O,name:R,email:U,phone:j,username:z}=A,{values:W,handlers:H}=p({livechatData:A.livechatData}),{handleLivechatData:J}=H,{livechatData:K}=W,[Q,X]=l(),[Y,Z]=l(),[$,ee]=l(),[te,ne]=l([]),{value:ae,phase:le}=_("livechat/custom-fields"),oe=e=>{const t={};return e.map(e=>{let{_id:n,label:a,visibility:l,options:o,scope:r,defaultValue:s,required:i}=e;return"visible"===l&"visitor"===r&&(t[n]={label:a,type:o?"select":"text",required:i,defaultValue:s,options:o&&o.split(",").map(e=>e.trim())})}),t},re=o(()=>ae&&ae.customFields?oe(ae.customFields):{},[ae]),se=v("POST","omnichannel/contact"),ie=v("GET","omnichannel/contact.search?email=".concat(U)),ce=v("GET","omnichannel/contact.search?phone=".concat(j)),ue=m(async()=>{if(!k(U))return;const{contact:e}=await ie();if(!e||t&&e._id===t)return Z(null);Z(T("Email_already_exists"))}),me=m(async()=>{if(!j)return;const{contact:e}=await ce();if(!e||t&&e._id===t)return ee(null);ee(T("Phone_already_exists"))}),de=C();f(()=>{X(R?"":T("The_field_is_required",T("Name")))},[T,R]),f(()=>{Z(U&&!k(U)?T("Validate_email_address"):null)},[T,U]),f(()=>{!j&&ee(null)},[j]);const he=m(async e=>{e.preventDefault();let n=!1;if(R||(X(T("The_field_is_required","name")),n=!0),U&&!k(U)&&(Z(T("Validate_email_address")),n=!0),n)return;const a={name:R};a.phone=j,a.email=U,a.customFields=K||{},a.contactManager=z?{username:z}:{},t?(a._id=t,a.token=O):a.token=w();try{await se(a),de({type:"success",message:T("Saved")}),u(),y()}catch(n){de({type:"error",message:n})}}),Ee=R&&!Y&&!$&&0===te.length;return[le].includes(F.LOADING)?a.createElement(D,null):a.createElement(a.Fragment,null,a.createElement(E.ScrollableContent,{is:"form"},a.createElement(r,null,a.createElement(r.Label,null,T("Name"),"*"),a.createElement(r.Row,null,a.createElement(s,{error:Q,flexGrow:1,value:R,onChange:P})),a.createElement(r.Error,null,Q)),a.createElement(r,null,a.createElement(r.Label,null,T("Email")),a.createElement(r.Row,null,a.createElement(s,{onBlur:ue,error:Y,flexGrow:1,value:U,onChange:V})),a.createElement(r.Error,null,T(Y))),a.createElement(r,null,a.createElement(r.Label,null,T("Phone")),a.createElement(r.Row,null,a.createElement(s,{onBlur:me,error:$,flexGrow:1,value:j,onChange:q})),a.createElement(r.Error,null,T($))),G()&&ae&&a.createElement(b,{jsonCustomFields:re,customFieldsData:K,setCustomFieldsData:J,setCustomFieldsError:ne}),B&&a.createElement(B,{value:z,handler:I})),a.createElement(E.Footer,null,a.createElement(i,{stretch:!0},a.createElement(c,{flexGrow:1,onClick:y},T("Cancel")),a.createElement(c,{mie:"none",flexGrow:1,onClick:he,disabled:!Ee,primary:!0},T("Save")))))}}

