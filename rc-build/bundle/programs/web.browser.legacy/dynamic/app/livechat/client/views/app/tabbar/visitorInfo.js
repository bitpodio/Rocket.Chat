function module(t,n,e){var i,r,o,a,s,c,u,l,f,d,m,v,h,g,p,w,k,C,_,I,y,D,R,A;e.link("@babel/runtime/regenerator",{default:function(t){i=t}},0),e.link("meteor/rocketchat:tap-i18n",{TAPi18n:function(t){r=t}},0),e.link("meteor/meteor",{Meteor:function(t){o=t}},1),e.link("meteor/reactive-var",{ReactiveVar:function(t){a=t}},2),e.link("meteor/kadira:flow-router",{FlowRouter:function(t){s=t}},3),e.link("meteor/session",{Session:function(t){c=t}},4),e.link("meteor/templating",{Template:function(t){u=t}},5),e.link("underscore",{default:function(t){l=t}},6),e.link("moment",{default:function(t){f=t}},7),e.link("ua-parser-js",{default:function(t){d=t}},8),e.link("../../../../../ui-utils",{modal:function(t){m=t}},9),e.link("../../../../../models",{Subscriptions:function(t){v=t}},10),e.link("../../../../../settings",{settings:function(t){h=t}},11),e.link("../../../../../utils",{t:function(t){g=t},handleError:function(t){p=t},roomTypes:function(t){w=t}},12),e.link("../../../../../authorization",{hasRole:function(t){k=t},hasPermission:function(t){C=t},hasAtLeastOnePermission:function(t){_=t}},13),e.link("./visitorInfo.html"),e.link("../../../../../utils/client",{APIClient:function(t){I=t}},14),e.link("../../../../../ui-utils/client",{RoomManager:function(t){y=t}},15),e.link("../../../../../lib/client",{DateFormat:function(t){D=t}},16),e.link("../customTemplates/register",{getCustomFormTemplate:function(t){R=t}},17),e.link("../../../../../markdown/client",{Markdown:function(t){A=t}},18);var B=function(){var t=u.currentData(),n;return!(!t||!t.rid)&&void 0!==v.findOne({rid:t.rid})},T=function(t){return!!h.get("Livechat_request_comment_when_closing_conversation")||t&&t.requestTagBeforeClosingChat};u.visitorInfo.helpers({user:function(){var t=u.instance().user.get();if(t&&t.userAgent){var n=new d;n.setUA(t.userAgent),t.os=n.getOS().name+" "+n.getOS().version,-1!==["Mac OS","iOS"].indexOf(n.getOS().name)?t.osIcon="icon-apple":t.osIcon="icon-"+n.getOS().name.toLowerCase(),t.browser=n.getBrowser().name+" "+n.getBrowser().version,t.browserIcon="icon-"+n.getBrowser().name.toLowerCase(),t.status=w.getUserStatus("l",this.rid)||"offline"}return t},room:function(){return u.instance().room.get()},department:function(){return u.instance().department.get()},joinTags:function(){var t=u.instance().tags.get();return t&&t.join(", ")},customRoomFields:function(){var t=u.instance().customFields.get();if(!t||0===t.length)return[];var n=[],e,i,r=(u.instance().room.get()||{}).livechatData,o=void 0===r?{}:r;return Object.keys(o).forEach((function(e){var i=l.findWhere(t,{_id:e});i&&"hidden"!==i.visibility&&"room"===i.scope&&n.push({label:i.label,value:o[e]})})),n},customVisitorFields:function(){var t=u.instance().customFields.get();if(_(["view-livechat-room-customfields","edit-livechat-room-customfields"])){if(!t||0===t.length)return[];var n=[],e,i,r=(u.instance().user.get()||{}).livechatData,o=void 0===r?{}:r;return Object.keys(o).forEach((function(e){var i=l.findWhere(t,{_id:e});i&&"hidden"!==i.visibility&&"visitor"===i.scope&&n.push({label:i.label,value:o[e]})})),n}},createdAt:function(){return this.createdAt?f(this.createdAt).format("L LTS"):""},lastLogin:function(){return this.lastLogin?f(this.lastLogin).format("L LTS"):""},editing:function(){return"edit"===u.instance().action.get()},forwarding:function(){return"forward"===u.instance().action.get()},sendingTranscript:function(){return"transcript"===u.instance().action.get()},roomInfoData:function(){var t=u.instance(),n=t.user.get();return{visitorId:n?n._id:null,roomId:this.rid,save:function(){t.action.set()},cancel:function(){t.action.set()}}},roomOpen:function(){var t=u.instance().room.get(),n=o.userId();return t&&t.open&&(t.servedBy&&t.servedBy._id===n||k(n,"livechat-manager"))},canReturnQueue:function(){var t;return u.instance().routingConfig.get().returnQueue},showDetail:function(){if(u.instance().action.get())return"hidden"},canSeeButtons:function(){return!!_(["close-others-livechat-room","transfer-livechat-guest"])||B()},canEditRoom:function(){return!!C("save-others-livechat-room-info")||B()},canCloseRoom:function(){return!!C("close-others-livechat-room")||B()},canForwardGuest:function(){return C("transfer-livechat-guest")},canSendTranscript:function(){var t;return!u.instance().room.get().email&&C("send-omnichannel-chat-transcript")},roomClosedDateTime:function(){var t=this.closedAt;return D.formatDateAndTime(t)},roomClosedBy:function(){var t=this.closedBy,n=void 0===t?{}:t,e=this.servedBy,i=void 0===e?{}:e,r=this.closer;if("user"===r){if(i._id!==n._id)return n.username;r="agent"}var o=r.charAt(0).toUpperCase()+r.slice(1);return g(""+o)},customInfoTemplate:function(){return R("livechatVisitorInfo")},roomDataContext:function(){return u.instance().room},transcriptRequest:function(){var t=u.instance().room.get();return null==t?void 0:t.transcriptRequest},transcriptRequestedDateTime:function(){var t=this.requestedAt;return D.formatDateAndTime(t)},markdown:function(t){return A.parse(t)}}),u.visitorInfo.events({"click .edit-livechat":function(t,n){t.preventDefault(),n.action.set("edit")},"click .close-livechat":function(t,n){if(t.preventDefault(),!T(n.department.get())){var e=r.__("Chat_closed_by_agent");return o.call("livechat:closeRoom",this.rid,e,{clientAction:!0},(function(t){if(t)return p(t);m.open({title:g("Chat_closed"),text:g("Chat_closed_successfully"),type:"success",timer:1e3,showConfirmButton:!1})}))}m.open({title:g("Closing_chat"),modifier:"modal",content:"closeRoom",data:{rid:this.rid},confirmOnEnter:!1,showConfirmButton:!1,showCancelButton:!1})},"click .return-inquiry":function(t){var n=this;t.preventDefault(),m.open({title:g("Would_you_like_to_return_the_inquiry"),type:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:g("Yes")},(function(){o.call("livechat:returnAsInquiry",n.rid,(function(t){t?p(t):(c.set("openedRoom"),s.go("/home"))}))}))},"click .forward-livechat":function(t,n){t.preventDefault(),n.action.set("forward")},"click .send-transcript":function(t,n){t.preventDefault(),n.action.set("transcript")}}),u.visitorInfo.onCreated((function(){var t=this;this.visitorId=new a(null),this.customFields=new a([]),this.action=new a,this.user=new a,this.departmentId=new a(null),this.tags=new a(null),this.routingConfig=new a({}),this.department=new a({}),this.room=new a({}),this.updateVisitor=function(){function n(n){var e,r;return i.async(function(){function o(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,i.awrap(I.v1.get("livechat/visitors.info?visitorId="+n));case 2:e=o.sent,r=e.visitor,t.user.set(r);case 5:case"end":return o.stop()}}return o}(),null,null,null,Promise)}return n}(),this.updateRoom=function(n){t.departmentId.set(n&&n.departmentId),t.tags.set(n&&n.tags),t.room.set(n);var e=n&&n.v&&n.v._id;t.visitorId.set(e),t.updateVisitor(e)},o.call("livechat:getCustomFields",(function(n,e){e&&t.customFields.set(e)}));var n,e=u.currentData().rid;o.call("livechat:getRoutingConfig",(function(n,e){e&&t.routingConfig.set(e)}));var r=function(){function n(n){var e,r;return i.async(function(){function o(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,i.awrap(I.v1.get("rooms.info?roomId="+n));case 2:e=o.sent,r=e.room,t.updateRoom(r);case 5:case"end":return o.stop()}}return o}(),null,null,null,Promise)}return n}();e&&(y.roomStream.on(e,this.updateRoom),r(e)),this.autorun(function(){function n(){var n,e;return i.async(function(){function r(r){for(;;)switch(r.prev=r.next){case 0:if(!t.departmentId.get()){r.next=6;break}return r.next=3,i.awrap(I.v1.get("livechat/department/"+t.departmentId.get()+"?includeAgents=false"));case 3:n=r.sent,e=n.department,t.department.set(e);case 6:case"end":return r.stop()}}return r}(),null,null,null,Promise)}return n}()),this.autorun((function(){var n=t.visitorId.get();n&&t.updateVisitor(n)}))})),u.visitorInfo.onDestroyed((function(){var t,n=u.currentData().rid;y.roomStream.removeListener(n,this.updateRoom)}))}

